# Ralph Progress Log

## Codebase Patterns

- Use Pydantic `alias` with `populate_by_name=True` when JSON uses camelCase but Python should use snake_case
- Use `by_alias=True` in `model_dump_json()` to serialize back to the original JSON format
- Import `Iterator`, `Sequence`, etc. from `collections.abc` instead of `typing` (ruff UP035)
- Use Pydantic `BaseModel` for all classes, NOT stdlib `@dataclass` - this is a Pydantic project
- Use `ConfigDict(arbitrary_types_allowed=True)` when fields use types like `Path` or `TextIO`
- Use `X | None` instead of `Optional[X]` for type annotations (ruff UP045)

---

## Log

(Iteration entries will be appended below)

---

## 2026-01-17 - US-010

**Story:** Set up Typer CLI app with help and version

### What was implemented
- Updated `src/ralph/cli.py` with --version/-V flag using version_callback
- Created command stub modules in `src/ralph/commands/`:
  - `init_cmd.py` - Scaffold project for Ralph workflow (stub)
  - `prd.py` - Interactive PRD creation with Claude (stub)
  - `tasks.py` - Convert spec to TASKS.json (stub)
  - `once.py` - Execute single iteration (stub)
  - `loop.py` - Run multiple iterations (stub)
  - `sync.py` - Sync skills to ~/.claude/skills/ (stub)
- Updated `commands/__init__.py` to export all command functions
- Registered all commands in main CLI app with descriptive help text
- Commands currently display "not yet implemented" warning until later stories

### Files changed
- src/ralph/cli.py (modified)
- src/ralph/commands/__init__.py (modified)
- src/ralph/commands/init_cmd.py (new)
- src/ralph/commands/prd.py (new)
- src/ralph/commands/tasks.py (new)
- src/ralph/commands/once.py (new)
- src/ralph/commands/loop.py (new)
- src/ralph/commands/sync.py (new)

### Learnings for future iterations
- Use `bool | None` instead of `Optional[bool]` to satisfy ruff UP045 rule
- Named init command file `init_cmd.py` to avoid conflict with Python's `init` module
- Command stubs use `typer.Exit(1)` to signal incomplete implementation

---

## 2026-01-17 - US-009

**Story:** Create skills sync service

### What was implemented
- Created `src/ralph/services/skills.py` with SkillsService class using Pydantic BaseModel
- Created `SyncStatus` enum for sync operation results (CREATED, UPDATED, SKIPPED, INVALID)
- Created `SkillInfo` model for skill metadata (name, description, path)
- Created `SkillSyncResult` model for sync operation results
- `list_local_skills()` - Finds skill directories containing SKILL.md in skills/ folder
- `validate_skill(path)` - Validates SKILL.md has required frontmatter (name, description)
- `sync_skill(skill_path)` - Copies skill to ~/.claude/skills/, returns status
- `sync_all()` - Syncs all valid skills, returns list of results
- `_parse_frontmatter()` - Simple YAML frontmatter parser without external dependency
- Updated `services/__init__.py` to export SkillsService, SkillInfo, SkillSyncResult, SyncStatus

### Files changed
- src/ralph/services/skills.py (new)
- src/ralph/services/__init__.py (modified)

### Learnings for future iterations
- Skills use SKILL.md with YAML frontmatter containing `name` and `description` fields
- Simple frontmatter parsing with regex avoids needing yaml dependency for this module
- Use shutil.copytree/rmtree for directory operations when syncing skills

---

## 2026-01-17 - US-008

**Story:** Create project scaffolding service

### What was implemented
- Created `src/ralph/services/scaffold.py` with ScaffoldService class using Pydantic BaseModel
- Created `ProjectType` enum for detected project types (Python, Node.js, Go, Rust, Unknown)
- `detect_project_type()` - Identifies project by marker files (pyproject.toml, package.json, go.mod, Cargo.toml)
- `create_plans_directory()` - Creates plans/ folder structure
- `create_spec_placeholder()` - Creates plans/SPEC.md with template
- `create_tasks_placeholder()` - Creates plans/TASKS.json with example structure
- `create_progress_placeholder()` - Creates plans/PROGRESS.txt with template
- `create_claude_md()` - Creates CLAUDE.md with project-specific quality checks template
- `create_agents_md()` - Creates AGENTS.md with Ralph workflow instructions
- `scaffold_all()` - Convenience method to create all files at once
- `_get_quality_checks_yaml()` - Returns appropriate quality checks YAML for detected project type
- Updated `services/__init__.py` to export ScaffoldService and ProjectType

### Files changed
- src/ralph/services/scaffold.py (new)
- src/ralph/services/__init__.py (modified)

### Learnings for future iterations
- Use Enum for type-safe project type detection
- Quality check templates should be project-type-specific for better developer experience
- Include Rust support alongside Python/Node.js/Go for broader coverage

---

## 2026-01-17 - US-007

**Story:** Create Claude Code CLI wrapper service

### What was implemented
- Created `src/ralph/services/claude.py` with ClaudeService dataclass
- `run_interactive(prompt)` - Launches Claude Code interactively with optional initial prompt
- `run_print_mode(prompt)` - Executes with -p flag, supports streaming output to terminal
- `run_with_output_format(prompt, format)` - Runs with specific output format (text/json/stream-json)
- All methods support: --verbose flag, model selection, max_turns, system_prompt, allowed_tools
- `_stream_output()` helper streams stdout line-by-line to terminal in real-time
- `_build_base_args()` constructs base CLI arguments
- Created `ClaudeError` exception class for operation failures
- Updated `services/__init__.py` to export ClaudeService and ClaudeError

### Files changed
- src/ralph/services/claude.py (new)
- src/ralph/services/__init__.py (modified)

### Learnings for future iterations
- Use `subprocess.Popen` with `stdout=PIPE` for streaming line-by-line output
- Use configurable `stdout`/`stderr` TextIO fields for testability (can inject StringIO in tests)
- Break long error messages across multiple lines to satisfy ruff E501 (max 100 chars)

---

## 2026-01-17 - US-006

**Story:** Create Git service for branch management

### What was implemented
- Created `src/ralph/services/git.py` with GitService dataclass
- `get_current_branch()` - Returns current branch name using `git branch --show-current`
- `get_default_branch()` - Detects main/master by checking local branches and remote HEAD
- `branch_exists(name)` - Checks if a branch exists locally
- `checkout_or_create_branch(name, base)` - Switches to branch, creates from base if needed
- `commit(message, add_all)` - Creates commit, optionally staging all changes first
- `has_changes()` - Checks for uncommitted changes via `git status --porcelain`
- `stage_files(files)` - Stages specific files for commit
- Created `GitError` exception class for operation failures
- Updated `services/__init__.py` to export GitService and GitError

### Files changed
- src/ralph/services/git.py (new)
- src/ralph/services/__init__.py (modified)

### Learnings for future iterations
- Use `@dataclass` for service classes that need configuration (like working_dir)
- `subprocess.run()` with `text=True` returns string output instead of bytes
- Check both local branches and remote HEAD when detecting default branch

---

## 2026-01-17 - US-005

**Story:** Create file operation utilities

### What was implemented
- Created `src/ralph/utils/files.py` with file operation utilities
- `ensure_dir(path)` - Creates directory and parents if they don't exist
- `read_file(path, encoding)` - Reads file contents with configurable encoding
- `write_file(path, content, encoding)` - Writes content to file, creates parent dirs
- `append_file(path, content, encoding)` - Appends content, creates file if needed
- `file_exists(path)` - Checks if path exists and is a file
- `get_project_root()` - Walks up directory tree looking for project markers (pyproject.toml, package.json, go.mod, Cargo.toml, CLAUDE.md, .git)
- Updated `utils/__init__.py` to export all new functions

### Files changed
- src/ralph/utils/files.py (new)
- src/ralph/utils/__init__.py (modified)

### Learnings for future iterations
- Using `pathlib.Path` provides clean, cross-platform file operations
- `Path.mkdir(parents=True, exist_ok=True)` is equivalent to `mkdir -p`
- Always create parent directories when writing files to prevent errors

---

## 2026-01-17 - US-004

**Story:** Create Rich console utilities

### What was implemented
- Created `src/ralph/utils/console.py` with Rich-based console helpers
- Added shared `Console` instance for consistent output across the application
- Implemented `print_success()` with green checkmark for success messages
- Implemented `print_error()` with red X for error messages
- Implemented `print_warning()` with yellow warning sign for warning messages
- Implemented `print_step()` for iteration progress display (e.g., `[1/5] Processing...`)
- Implemented `create_spinner()` context manager using Rich's status spinner
- Updated `utils/__init__.py` to export all public symbols

### Files changed
- src/ralph/utils/console.py (new)
- src/ralph/utils/__init__.py (modified)

### Learnings for future iterations
- Import `Iterator` from `collections.abc` instead of `typing` to satisfy ruff UP035 rule
- Rich's `console.status()` provides an easy way to create spinners with context manager syntax

---

## 2026-01-17 - US-003

**Story:** Create configuration models and quality check parser

### What was implemented
- Created `src/ralph/models/config.py` with QualityCheck and QualityChecks Pydantic models
- QualityCheck model includes: name, command, required (with default=True)
- QualityChecks model contains a list of QualityCheck items
- Implemented `parse_quality_checks()` to extract YAML between RALPH:CHECKS:START and RALPH:CHECKS:END markers using regex
- Implemented `load_quality_checks()` helper to load directly from a file path
- Parser returns empty QualityChecks on missing markers or malformed YAML (graceful degradation)
- Added pyyaml>=6.0.0 dependency to pyproject.toml
- Updated `models/__init__.py` to export all new public symbols

### Files changed
- src/ralph/models/config.py (new)
- src/ralph/models/__init__.py (modified)
- pyproject.toml (modified)
- uv.lock (modified)

### Learnings for future iterations
- Use `yaml.safe_load()` for security when parsing untrusted YAML content
- Regex with `re.DOTALL` flag is useful for matching across multiple lines
- Return empty container models instead of None for graceful handling of missing/malformed data

---

## 2026-01-17 - US-002

**Story:** Create Pydantic models for TASKS.json

### What was implemented
- Created `src/ralph/models/tasks.py` with UserStory and TasksFile Pydantic models
- UserStory model includes: id, title, description, acceptance_criteria, priority, passes, notes
- TasksFile model includes: project, branch_name, description, user_stories
- Used Pydantic aliases to maintain camelCase JSON compatibility (e.g., `acceptanceCriteria` in JSON maps to `acceptance_criteria` in Python)
- Implemented `load_tasks()` function to read and validate TASKS.json files
- Implemented `save_tasks()` function to serialize models back to JSON with proper camelCase
- Updated `models/__init__.py` to export all public symbols

### Files changed
- src/ralph/models/tasks.py (new)
- src/ralph/models/__init__.py (modified)

### Learnings for future iterations
- Ruff lint rule N815 flags mixedCase variables; use Pydantic aliases to satisfy both Python conventions and external JSON schemas
- `ConfigDict(populate_by_name=True)` allows models to accept both alias (camelCase) and field name (snake_case)
- Remember to use `by_alias=True` when serializing to preserve original JSON format

---

## 2026-01-17 - US-001

**Story:** Initialize project structure with pyproject.toml

### What was implemented
- Created pyproject.toml with all required dependencies (typer, rich, pydantic, ruff, pytest, pytest-cov, pyright)
- Configured hatchling build backend with src layout
- Set up Python 3.11+ requirement
- Created src/ralph/ directory structure with __init__.py files
- Created empty module directories: commands/, models/, services/, utils/
- Created basic cli.py with Typer app entry point
- Added README.md with basic documentation
- Added .gitignore for Python projects
- Added initial test for version verification
- Verified package installs successfully with `uv pip install -e ".[dev]"`

### Files changed
- pyproject.toml (new)
- README.md (new)
- .gitignore (new)
- src/ralph/__init__.py (new)
- src/ralph/cli.py (new)
- src/ralph/commands/__init__.py (new)
- src/ralph/models/__init__.py (new)
- src/ralph/services/__init__.py (new)
- src/ralph/utils/__init__.py (new)
- tests/__init__.py (new)
- tests/test_init.py (new)

### Learnings for future iterations
- pytest returns exit code 5 when no tests are collected, so at least one test file is needed
- hatchling requires README.md to exist if referenced in pyproject.toml
- uv requires a virtual environment to be created first with `uv venv`

---

## 2026-01-17 - US-011

**Story:** Implement ralph init command

### What was implemented
- Implemented full `ralph init` command in `src/ralph/commands/init_cmd.py`
- Uses `ScaffoldService` to create all Ralph workflow files
- Detects project type (Python, Node.js, Go, Rust) and sets appropriate quality checks
- Added `--force` flag to overwrite existing files
- Added `--skip-claude` flag to skip Claude Code /init invocation
- Added `--name` flag to customize project name
- Checks for existing Ralph files and warns before overwriting
- Invokes Claude Code `/init` to enhance CLAUDE.md and AGENTS.md
- Displays success message with next steps after initialization
- Added `_check_existing_files()` helper function

### Tests written
- `tests/test_commands/test_init_cmd.py` with 13 tests:
  - `test_init_creates_ralph_files` - verifies all files are created
  - `test_init_detects_python_project` - verifies Python detection
  - `test_init_detects_nodejs_project` - verifies Node.js detection
  - `test_init_refuses_overwrite_without_force` - verifies protection
  - `test_init_with_force_overwrites_files` - verifies --force flag
  - `test_init_with_skip_claude` - verifies --skip-claude flag
  - `test_init_with_custom_project_name` - verifies --name flag
  - `test_init_shows_next_steps` - verifies output messages
  - `test_init_handles_claude_error_gracefully` - verifies error handling
  - Tests for `_check_existing_files` helper function

### Files changed
- src/ralph/commands/init_cmd.py (modified)
- tests/test_commands/__init__.py (new)
- tests/test_commands/test_init_cmd.py (new)

### Learnings for future iterations
- Use `typer.testing.CliRunner` for testing CLI commands
- Change working directory with `os.chdir()` in tests, but always restore with `try/finally`
- Mock `ClaudeService` to avoid actually calling Claude during tests
- Use `Path.relative_to()` to display clean paths in output

---

## 2026-01-17 - US-012

**Story:** Implement ralph prd command

### What was implemented
- Implemented full `ralph prd` command in `src/ralph/commands/prd.py`
- Displays informational message before launching Claude (tips for good PRD session)
- Launches Claude Code in interactive mode with a structured PRD prompt
- Prompt includes PRD structure guidance: Overview, Goals, Non-Goals, Requirements, Technical Considerations, Success Criteria
- Added `--output` flag to customize output path (default: plans/SPEC.md)
- Added `--verbose` flag for verbose Claude output
- Checks for plans/ directory existence before launching
- Notes when SPEC.md already exists (update vs create)
- Shows success message with next steps when PRD is created
- Handles errors gracefully (non-zero exit, ClaudeError)

### Tests written
- `tests/test_commands/test_prd.py` with 15 tests:
  - `test_prd_requires_plans_directory` - verifies plans/ check
  - `test_prd_displays_informational_message` - verifies tips display
  - `test_prd_launches_claude_interactively` - verifies ClaudeService usage
  - `test_prd_includes_prd_prompt` - verifies prompt structure
  - `test_prd_shows_output_path` - verifies output path display
  - `test_prd_success_with_file_created` - verifies success handling
  - `test_prd_warning_when_file_not_created` - verifies cancelled session handling
  - `test_prd_handles_nonzero_exit_code` - verifies exit code handling
  - `test_prd_handles_claude_error` - verifies ClaudeError handling
  - `test_prd_notes_existing_spec` - verifies existing file note
  - `test_prd_with_custom_output_path` - verifies --output flag
  - `test_prd_with_verbose_flag` - verifies --verbose flag
  - Tests for `_build_prd_prompt` helper function

### Files changed
- src/ralph/commands/prd.py (modified)
- tests/test_commands/test_prd.py (new)

### Learnings for future iterations
- Use `_build_prd_prompt()` helper to keep prompt construction testable
- Check for prerequisite directories (like plans/) before launching interactive sessions
- Display helpful tips before launching interactive Claude sessions to improve UX

---

## 2026-01-17 - US-013

**Story:** Implement ralph tasks command

### What was implemented
- Implemented full `ralph tasks` command in `src/ralph/commands/tasks.py`
- Accepts spec file path argument (with typer validation for existence/readability)
- Invokes Claude Code in print mode (non-streaming) to generate TASKS.json
- Builds comprehensive prompt with JSON schema and story-creation guidelines
- Added `_extract_json()` helper to extract JSON from various formats:
  - Pure JSON
  - JSON wrapped in markdown code blocks (```json)
  - JSON embedded in surrounding text
- Validates Claude output against TasksFile Pydantic model
- Saves validated output to plans/TASKS.json (or custom path with --output)
- Added `--output` flag for custom output path
- Added `--verbose` flag for verbose Claude output
- Added `--branch` flag for custom branch name in generated tasks
- Displays success message with story count and next steps
- Handles errors gracefully: empty spec, Claude failures, invalid JSON, validation errors

### Tests written
- `tests/test_commands/test_tasks.py` with 35 tests:
  - `TestTasksCommand` class (17 tests):
    - `test_tasks_requires_spec_file_argument` - verifies argument required
    - `test_tasks_fails_for_nonexistent_file` - verifies file validation
    - `test_tasks_fails_for_empty_spec_file` - verifies empty file handling
    - `test_tasks_displays_informational_message` - verifies output
    - `test_tasks_launches_claude_in_print_mode` - verifies Claude invocation
    - `test_tasks_includes_spec_content_in_prompt` - verifies prompt building
    - `test_tasks_validates_claude_output` - verifies Pydantic validation
    - `test_tasks_saves_valid_output` - verifies file creation
    - `test_tasks_shows_success_message_with_story_count` - verifies success output
    - `test_tasks_handles_nonzero_exit_code` - verifies exit code handling
    - `test_tasks_handles_claude_error` - verifies ClaudeError handling
    - `test_tasks_notes_existing_tasks_json` - verifies existing file note
    - `test_tasks_with_custom_output_path` - verifies --output flag
    - `test_tasks_with_verbose_flag` - verifies --verbose flag
    - `test_tasks_with_branch_name_flag` - verifies --branch flag
    - `test_tasks_handles_no_json_in_output` - verifies no-JSON handling
  - `TestExtractJson` class (7 tests) for _extract_json helper
  - `TestIsValidJson` class (4 tests) for _is_valid_json helper
  - `TestBuildTasksPrompt` class (6 tests) for _build_tasks_prompt helper

### Files changed
- src/ralph/commands/tasks.py (modified - full implementation)
- tests/test_commands/test_tasks.py (new)

### Learnings for future iterations
- Use non-streaming mode (`stream=False`) when you need to capture and process Claude output
- Extract JSON robustly by trying multiple patterns: pure JSON, code blocks, embedded JSON
- Regex `[\s\S]*?` is useful for non-greedy matching across newlines in code blocks
- Pydantic `model_validate_json()` directly validates JSON strings without intermediate dict

---

## 2026-01-17 - US-014

**Story:** Implement ralph once command

### What was implemented
- Full `ralph once` command implementation in `src/ralph/commands/once.py`
- `ITERATION_PROMPT` constant with comprehensive iteration instructions for Claude
- `_find_next_story()` helper to find highest-priority incomplete story
- `_build_iteration_prompt()` helper to format story details into prompt
- `_append_cli_summary()` helper to append minimal CLI summary to PROGRESS.txt
- Load TASKS.json and validate structure using Pydantic models
- Exit with "All stories complete" when no incomplete stories remain
- Invoke Claude Code in print mode with streaming output
- Support `--verbose` flag for full JSON output
- Support `--max-fix-attempts` flag (default: 3) passed to iteration prompt
- Detect story completion by re-reading TASKS.json after Claude runs
- Display iteration summary with success/failure status
- Detect `<ralph>COMPLETE</ralph>` signal when all stories complete

### Tests written
- `tests/test_commands/test_once.py` with 19 tests:
  - `TestOnceCommand` class (12 tests):
    - `test_once_requires_tasks_json` - verifies TASKS.json requirement
    - `test_once_displays_story_info` - verifies story display
    - `test_once_picks_highest_priority_incomplete_story` - verifies priority logic
    - `test_once_exits_when_all_stories_complete` - verifies completion handling
    - `test_once_runs_claude_in_print_mode` - verifies Claude invocation
    - `test_once_handles_claude_error` - verifies error handling
    - `test_once_shows_remaining_count` - verifies progress display
    - `test_once_detects_all_complete_signal` - verifies COMPLETE detection
    - `test_once_with_verbose_flag` - verifies --verbose flag
    - `test_once_includes_max_fix_attempts_in_prompt` - verifies --max-fix-attempts
    - `test_once_detects_story_passed` - verifies success detection
    - `test_once_handles_invalid_tasks_json` - verifies error handling
  - `TestFindNextStory` class (3 tests) for _find_next_story helper
  - `TestBuildIterationPrompt` class (4 tests) for _build_iteration_prompt helper

### Files changed
- src/ralph/commands/once.py (modified - full implementation)
- tests/test_commands/test_once.py (new)

### Learnings for future iterations
- Use `datetime.UTC` instead of `timezone.utc` (ruff UP017)
- Initialize variables before try blocks to avoid "possibly unbound" pyright errors
- Use backslash continuation for long lines in multiline strings to satisfy ruff E501
- Re-read TASKS.json after Claude runs to detect if the story was marked as passed
- The `<ralph>COMPLETE</ralph>` signal indicates all stories are complete

---

## 2026-01-17 - US-015

**Story:** Implement ralph loop command

### What was implemented
- Full `ralph loop` command implementation in `src/ralph/commands/loop.py`
- `LoopStopReason` class with constants: ALL_COMPLETE, MAX_ITERATIONS, PERSISTENT_FAILURE, TRANSIENT_FAILURE, NO_TASKS, BRANCH_MISMATCH
- `_setup_branch()` helper to check/create feature branch from TASKS.json branchName
- `_find_next_story()` helper (reused pattern from once.py)
- `_build_iteration_prompt()` helper (reuses ITERATION_PROMPT from once.py)
- `_append_loop_progress()` helper for PROGRESS.txt updates
- Branch setup: checks current branch, warns about uncommitted changes, creates/switches as needed
- Iteration tracking: displays `[N/M] StoryID: Title` counter using print_step()
- Stop conditions: all complete, max iterations, persistent failure (same story fails 2x), transient failure (Claude error)
- Summary display: stories completed, total progress, remaining count, stop reason
- Supports `--verbose` and `--max-fix-attempts` flags

### Tests written
- `tests/test_commands/test_loop.py` with 27 tests:
  - `TestLoopCommand` class (15 tests): requires TASKS.json, displays project info, handles all complete, runs multiple iterations, stops on all complete signal, stops on max iterations, stops on persistent failure, handles Claude error, verbose flag, custom iterations, iteration counter, summary on completion, invalid TASKS.json, branch setup failure
  - `TestSetupBranch` class (6 tests): on correct branch, switches branch, creates new branch, warns uncommitted changes, handles git error, handles checkout error
  - `TestFindNextStory` class (3 tests): returns highest priority incomplete, returns None when all complete, handles unsorted priorities
  - `TestBuildIterationPrompt` class (3 tests): includes story details, acceptance criteria, max fix attempts
  - `TestLoopStopReason` class (1 test): stop reason constants exist

### Files changed
- src/ralph/commands/loop.py (modified - full implementation)
- tests/test_commands/test_loop.py (new)
- plans/TASKS.json (updated)

### Learnings for future iterations
- Reuse constants/prompts from related modules (ITERATION_PROMPT from once.py) to maintain consistency
- Use a dedicated class for stop reason constants to improve code clarity
- Branch switching should warn about uncommitted changes but still attempt the operation
- Persistent failure detection requires tracking consecutive failures on the same story ID
- The `_setup_branch` function is a good candidate for sharing between commands that need branch management

---

## 2026-01-17 - US-016

**Story:** Implement ralph sync command

### What was implemented
- Full `ralph sync` command implementation in `src/ralph/commands/sync.py`
- Uses SkillsService to list, validate, and sync skills from skills/ directory
- Displays source and target directories before syncing
- Shows status for each skill: created (green checkmark), updated, invalid (yellow warning), error (red X)
- Displays summary with counts: total synced, created, updated, invalid, errors
- Shows helpful message when skills/ directory doesn't exist or is empty
- Added `--skills-dir` / `-s` flag for custom skills directory
- Exits with code 1 if any skills fail to sync (SyncStatus.SKIPPED)

### Tests written
- `tests/test_commands/test_sync.py` with 11 tests:
  - `TestSyncCommand` class (10 tests):
    - `test_sync_shows_warning_when_no_skills_dir` - verifies missing skills/ handling
    - `test_sync_shows_warning_when_no_skills_found` - verifies empty skills/ handling
    - `test_sync_syncs_valid_skill` - verifies successful sync
    - `test_sync_shows_updated_status` - verifies updated status display
    - `test_sync_shows_invalid_skill_warning` - verifies invalid skill handling
    - `test_sync_with_custom_skills_dir` - verifies --skills-dir flag
    - `test_sync_fails_on_error` - verifies exit code on errors
    - `test_sync_displays_source_and_target` - verifies path display
    - `test_sync_multiple_skills` - verifies multiple skill handling
    - `test_sync_shows_no_skills_synced_when_all_invalid` - verifies all-invalid case
  - `TestSyncIntegration` class (1 test):
    - `test_sync_actually_copies_skill` - integration test verifying files are copied

### Files changed
- src/ralph/commands/sync.py (modified - full implementation)
- tests/test_commands/test_sync.py (new)

### Learnings for future iterations
- SkillsService already does the heavy lifting; command just orchestrates and displays
- Use Unicode checkmark/cross symbols for visual feedback in terminal
- Pydantic model fields can be customized at instantiation (target_dir) for testing
- Exit with non-zero code for errors but zero for warnings (invalid skills)

---

## 2026-01-17 - US-017

**Story:** Create ralph-prd skill definition

### What was implemented
- Created `skills/ralph-prd/SKILL.md` with required YAML frontmatter (name, description)
- Phase 1: Discovery questions covering project context, feature overview, scope definition, and technical considerations
- Phase 2: PRD generation with structured output format template
- Output format section with complete PRD markdown template for plans/SPEC.md
- Guidelines for feature scoping (right-size features, avoid scope creep, think in iterations)
- Guidelines for requirements quality (specific, testable, independent)
- Interaction style guidance (ask one category at a time, summarize understanding, be concise)
- Next steps prompt directing users to run `ralph tasks plans/SPEC.md`

### Tests written
- No Python tests needed for this story (skill is a markdown instruction file)
- Skill format validated by existing SkillsService tests (validates frontmatter parsing)

### Files changed
- skills/ralph-prd/SKILL.md (new)

### Learnings for future iterations
- Skills are markdown files with YAML frontmatter containing `name` and `description`
- Skills should guide Claude through a multi-phase process (discovery, then generation)
- Include concrete output format templates to ensure consistent results
- Always end skill instructions with next steps for the user

---

## 2026-01-17 - US-018

**Story:** Create ralph-tasks skill definition

### What was implemented
- Created `skills/ralph-tasks/SKILL.md` with required YAML frontmatter (name, description)
- Story sizing guidelines: right-sized stories (3-6 criteria, 5-7 files max), signs of too large/small stories
- Story breakdown patterns: foundational first, vertical slices for features
- Priority assignment guidance: 1-5 for models, 6-10 for services, 11-15 for commands, 16-20 for features, 21+ for tests
- Dependency rules: models before services, services before commands, core before extensions
- Acceptance criteria guidance: specific, testable, independent criteria with format examples
- Full TASKS.json output schema with field descriptions table
- Example transformation showing how to convert requirements to structured user stories
- Quality checks section for validating generated output
- Handling ambiguity guidance for unclear specifications

### Tests written
- No Python tests needed for this story (skill is a markdown instruction file)
- Skill format validated by existing SkillsService tests (validates frontmatter parsing)

### Files changed
- skills/ralph-tasks/SKILL.md (new)

### Learnings for future iterations
- Skills should provide concrete examples (like the example transformation) to guide Claude output
- Priority ranges help establish consistent ordering patterns across projects
- Include a quality checklist at the end for self-validation before output

---

## 2026-01-17 - US-019

**Story:** Create ralph-iteration skill definition

### What was implemented
- Created `skills/ralph-iteration/SKILL.md` with required YAML frontmatter (name, description)
- Structured skill into 4 phases: Context Gathering, Story Implementation, Quality Verification, Completion
- Phase 1 covers reading TASKS.json, PROGRESS.txt patterns, CLAUDE.md checks, and branch verification
- Phase 2 covers understanding story, planning approach, implementing, writing tests, self-review
- Phase 3 covers running quality checks, fix loop behavior (max 3 attempts), common issues table
- Phase 4 covers commit message format, TASKS.json updates, PROGRESS.txt appending, memory file updates
- Included detailed fix loop behavior with analyze/identify/fix/re-run cycle
- Documented commit message format: `feat: [Story ID] - [Story Title]`
- Added PROGRESS.txt format template with all required sections
- Included guidance on updating Codebase Patterns section for reusable discoveries
- Added CLAUDE.md/AGENTS.md update instructions (must stay in sync)
- Documented stop condition with `<ralph>COMPLETE</ralph>` signal
- Added error handling section for blocked/incomplete stories
- Included file reference table for quick lookup

### Tests written
- No Python tests needed for this story (skill is a markdown instruction file)
- Skill format validated by existing SkillsService tests (validates frontmatter parsing)

### Files changed
- skills/ralph-iteration/SKILL.md (new)

### Learnings for future iterations
- Skills should break complex workflows into clear phases for better agent understanding
- Include concrete examples (commit messages, JSON updates) rather than abstract descriptions
- Add error handling guidance so agents know what to do when blocked
- A file reference table at the end provides quick lookup during execution

---

## 2026-01-17 - US-020

**Story:** Add tests for Pydantic models

### What was implemented
- Created `tests/test_models.py` with comprehensive tests for all Pydantic models
- 42 tests covering model validation, serialization, and helper functions
- Test classes organized by model/function: TestUserStory, TestTasksFile, TestQualityCheck, TestQualityChecks, TestLoadTasks, TestSaveTasks, TestParseQualityChecks, TestLoadQualityChecks

### Tests written
- `TestUserStory` (7 tests): valid data, minimal fields, camelCase alias, serialization, missing fields, invalid types
- `TestTasksFile` (6 tests): valid data, minimal fields, camelCase aliases, serialization, missing fields, nested validation
- `TestQualityCheck` (4 tests): valid data, default required, optional required, missing fields
- `TestQualityChecks` (4 tests): multiple checks, empty list, default empty, from dict
- `TestLoadTasks` (5 tests): valid file, nonexistent file, invalid JSON, invalid structure, empty file
- `TestSaveTasks` (4 tests): creates file, writes valid JSON, uses aliases, round-trip
- `TestParseQualityChecks` (9 tests): valid block, missing markers, no markers, invalid YAML, not dict, optional check, empty list, whitespace handling
- `TestLoadQualityChecks` (3 tests): from file, nonexistent file, file without checks

### Files changed
- tests/test_models.py (new)

### Learnings for future iterations
- Pydantic's `model_validate_json()` raises `ValidationError` for both invalid JSON syntax and invalid structure
- Use `pytest.raises(ValidationError)` to test both missing required fields and invalid types
- Test both snake_case Python attribute access and camelCase JSON serialization to ensure aliases work correctly
- Round-trip tests (save then load) are valuable for verifying serialization consistency

---

## 2026-01-17 - US-021

**Story:** Add tests for Git service

### What was implemented
- Created `tests/test_services/test_git.py` with 31 comprehensive tests for GitService
- Created pytest fixtures: `temp_git_repo` (creates isolated git repo) and `git_service` (GitService instance)
- Test classes organized by method: TestGetCurrentBranch, TestGetDefaultBranch, TestBranchExists, TestCheckoutOrCreateBranch, TestCommit, TestHasChanges, TestStageFiles
- Additional test classes: TestGitServiceRun (internal _run method), TestGitError, TestGitServiceWorkingDir

### Tests written
- `TestGetCurrentBranch` (3 tests): returns main, returns feature branch, raises for non-repo
- `TestGetDefaultBranch` (3 tests): returns main, returns master when only master exists, defaults to main
- `TestBranchExists` (2 tests): returns true for existing, false for nonexistent
- `TestCheckoutOrCreateBranch` (4 tests): checks out existing, creates new from default, creates from specified base, raises for invalid base
- `TestCommit` (4 tests): creates with message, creates with add_all, raises when nothing to commit, handles special characters
- `TestHasChanges` (4 tests): returns false when clean, true with unstaged/untracked/staged changes
- `TestStageFiles` (4 tests): stages single/multiple files, does nothing with empty list, raises for nonexistent
- `TestGitServiceRun` (2 tests): raises for invalid command, does not raise with check=False
- `TestGitError` (2 tests): stores message, is Exception subclass
- `TestGitServiceWorkingDir` (3 tests): default is None, custom working_dir, working_dir used for commands

### Files changed
- tests/test_services/__init__.py (new)
- tests/test_services/test_git.py (new)

### Learnings for future iterations
- Use `pytest.fixture` with `tmp_path` to create isolated git repos for testing
- Configure git user.email and user.name in test fixtures to avoid commit failures
- Use `git branch -M main` to ensure consistent branch naming across different git versions
- The `temp_git_repo` fixture pattern can be reused for other tests needing git operations

---

## 2026-01-17 - US-022

**Story:** Add tests for scaffold service

### What was implemented
- Created `tests/test_services/test_scaffold.py` with 42 comprehensive tests for ScaffoldService
- Test classes organized by method/functionality:
  - `TestProjectType` (1 test) - Tests enum values
  - `TestDetectProjectType` (8 tests) - Tests project detection for Python, Node.js, Go, Rust
  - `TestCreatePlansDirectory` (2 tests) - Tests plans/ directory creation
  - `TestCreateSpecPlaceholder` (2 tests) - Tests SPEC.md creation and content
  - `TestCreateTasksPlaceholder` (3 tests) - Tests TASKS.json creation and JSON validity
  - `TestCreateProgressPlaceholder` (2 tests) - Tests PROGRESS.txt creation and structure
  - `TestCreateClaudeMd` (9 tests) - Tests CLAUDE.md with project-specific quality checks
  - `TestCreateAgentsMd` (5 tests) - Tests AGENTS.md creation and content
  - `TestScaffoldAll` (3 tests) - Tests full scaffolding workflow
  - `TestGetQualityChecksYaml` (5 tests) - Tests quality check YAML generation
  - `TestScaffoldServiceModel` (2 tests) - Tests Pydantic model configuration

### Tests written
- 42 tests covering all ScaffoldService methods and ProjectType enum
- Tests verify file creation, content structure, project type detection, and quality check templates
- All tests use pytest's `tmp_path` fixture for isolated temporary directories

### Files changed
- tests/test_services/test_scaffold.py (new)
- plans/TASKS.json (updated)

### Learnings for future iterations
- ScaffoldService uses Pydantic BaseModel with ConfigDict(arbitrary_types_allowed=True) for Path support
- Quality check templates are project-type-specific and defined in _get_quality_checks_yaml()
- Test organization by method/class mirrors the source structure for easy navigation

---

## 2026-01-17 - US-023

**Story:** Add integration tests for CLI commands

### What was implemented
- Created `tests/test_cli.py` with comprehensive integration tests for the Ralph CLI
- Test classes organized by functionality:
  - `TestCliHelp` (5 tests): --help shows all commands, app description, version option, no args shows help, command-specific help
  - `TestCliVersion` (3 tests): --version and -V flags, version format includes app name
  - `TestInitIntegration` (4 tests): creates all ralph files, valid TASKS.json, CLAUDE.md with quality checks, --skip-claude flag
  - `TestSyncIntegration` (4 tests): copies skills to target, custom skills directory, displays summary, handles missing skills directory
  - `TestCommandsExist` (6 tests): verifies all commands are registered (init, prd, tasks, once, loop, sync)
  - `TestErrorHandling` (3 tests): unknown command error, invalid option error, tasks without file error

### Tests written
- 25 tests total covering:
  - CLI help and version display
  - Integration tests for init command (file creation, JSON validity, quality check markers)
  - Integration tests for sync command (skill copying, custom directories, summaries)
  - Command registration verification for all 6 commands
  - Error handling for invalid commands and options

### Files changed
- tests/test_cli.py (new)
- plans/TASKS.json (updated)

### Learnings for future iterations
- Typer's `no_args_is_help=True` returns exit code 2, not 0 - test for this explicitly
- Use `CliRunner` from `typer.testing` for testing CLI commands
- Integration tests should verify both file creation and file content validity
- Test command registration by checking `--help` output for each command

---

## 2026-01-17 - US-001

**Story:** Add skip_permissions parameter to ClaudeService

### What was implemented
- Added `skip_permissions: bool = False` parameter to `ClaudeService.run_print_mode()`
- When `skip_permissions=True`, appends `--dangerously-skip-permissions` to CLI args
- Updated docstring to document the new parameter

### Tests written
- `test_includes_skip_permissions_when_true` - verifies flag is included when True
- `test_excludes_skip_permissions_when_false` - verifies flag is NOT included when False
- `test_default_skip_permissions_is_false` - verifies default behavior excludes the flag

### Files changed
- src/ralph/services/claude.py (modified)
- tests/test_services/test_claude.py (modified)

### Learnings for future iterations
- The `--dangerously-skip-permissions` flag enables autonomous execution without permission prompts
- Place new parameters after existing keyword-only parameters in method signatures

---

## 2026-01-17 - US-002

**Story:** Enable skip_permissions in ralph once command

### What was implemented
- Added `skip_permissions=True` to `run_print_mode()` call in `once.py`
- Added info message: "Running Claude with auto-approved permissions for autonomous iteration"
- Message is displayed before Claude starts running

### Tests written
- `test_once_passes_skip_permissions_true` - verifies `skip_permissions=True` is passed to `run_print_mode()`
- `test_once_displays_permissions_message` - verifies the info message is displayed

### Files changed
- src/ralph/commands/once.py (modified)
- tests/test_commands/test_once.py (modified)

### Learnings for future iterations
- The skip_permissions parameter is passed as a keyword argument to `run_print_mode()`
- Use Rich markup `[dim]` for informational messages that shouldn't distract from main output

---

## 2026-01-17 - US-003

**Story:** Enable skip_permissions in ralph loop command

### What was implemented
- Added `skip_permissions=True` to `run_print_mode()` call in `loop.py`
- Added one-time info message: "Running Claude with auto-approved permissions for autonomous iteration"
- Message is displayed once at the start of the loop, before iterations begin

### Tests written
- `test_loop_passes_skip_permissions_true` - verifies `skip_permissions=True` is passed to `run_print_mode()`
- `test_loop_displays_permissions_message` - verifies the info message is displayed

### Files changed
- src/ralph/commands/loop.py (modified)
- tests/test_commands/test_loop.py (modified)

### Learnings for future iterations
- The one-time info message should appear before the loop starts, not per-iteration
- Reuse the same message text as `once.py` for consistency across commands

---

## 2026-01-17 - US-004

**Story:** Add --input flag to ralph prd command

### What was implemented
- Added `--input / -i` option to `prd()` function in `src/ralph/commands/prd.py`
- Created `_run_non_interactive()` helper function for non-interactive PRD generation
- Created `_build_non_interactive_prd_prompt()` helper to build the non-interactive prompt
- When `--input` is provided:
  - Displays "Non-Interactive PRD Generation" header
  - Shows the feature description being processed
  - Uses `run_print_mode()` instead of `run_interactive()`
  - Passes feature description to Claude for PRD generation

### Tests written
- `TestPrdInputFlag` class with 7 tests:
  - `test_prd_with_input_runs_non_interactive` - verifies --input triggers non-interactive mode
  - `test_prd_with_input_uses_print_mode` - verifies run_print_mode is called
  - `test_prd_with_input_includes_feature_description` - verifies feature in prompt
  - `test_prd_with_input_displays_feature_description` - verifies feature in output
  - `test_prd_with_input_success_creates_file` - verifies success handling
  - `test_prd_with_input_handles_claude_error` - verifies error handling
  - `test_prd_with_input_handles_nonzero_exit` - verifies exit code handling
- `TestBuildNonInteractivePrdPrompt` class with 4 tests for the helper function

### Files changed
- src/ralph/commands/prd.py (modified)
- tests/test_commands/test_prd.py (modified)

### Learnings for future iterations
- Non-interactive mode should use `run_print_mode()` instead of `run_interactive()`
- The non-interactive prompt should NOT ask for clarifying questions (goes straight to generation)
- Display the feature description in output so user knows what's being processed

---

## 2026-01-17 - US-005

**Story:** Add --file flag to ralph prd command

### What was implemented
- Added `--file / -f` option to `prd()` function in `src/ralph/commands/prd.py`
- When `--file` is provided:
  - Reads file contents as the feature description
  - Uses `_run_non_interactive()` for PRD generation (same as `--input`)
  - Error handling for non-existent files ("File not found")
  - Error handling for empty files ("File is empty")
  - Strips whitespace from file contents
- Updated docstring to mention `--file` option

### Tests written
- `TestPrdFileFlag` class with 7 tests:
  - `test_prd_with_file_runs_non_interactive` - verifies --file triggers non-interactive mode
  - `test_prd_with_file_reads_file_contents` - verifies file contents used as feature description
  - `test_prd_with_file_error_when_file_not_exists` - verifies error for missing file
  - `test_prd_with_file_error_when_file_empty` - verifies error for empty file
  - `test_prd_with_file_displays_feature_description` - verifies feature in output
  - `test_prd_with_file_success_creates_file` - verifies success handling
  - `test_prd_with_file_strips_whitespace` - verifies whitespace handling

### Files changed
- src/ralph/commands/prd.py (modified)
- tests/test_commands/test_prd.py (modified)

### Learnings for future iterations
- Reuse `_run_non_interactive()` for both `--input` and `--file` modes to avoid duplication
- Always validate file existence and content before processing
- Use `read_text().strip()` to handle whitespace in input files

---

## 2026-01-17 - US-006

**Story:** Make --input and --file mutually exclusive

### What was implemented
- Added mutual exclusivity check in `prd()` function for `--input` and `--file` flags
- Check occurs early, after plans/ directory validation but before any processing
- Error message is clear: "Cannot use both --input and --file at the same time."
- Actionable guidance is provided: explains to use one or the other, but not both
- Exits with code 1 when both flags are provided

### Tests written
- `TestPrdMutualExclusivity` class with 4 tests:
  - `test_prd_error_when_both_input_and_file_provided` - verifies error message is displayed
  - `test_prd_mutual_exclusivity_error_is_actionable` - verifies message explains what to do
  - `test_prd_mutual_exclusivity_exits_nonzero` - verifies exit code is 1
  - `test_prd_mutual_exclusivity_does_not_call_claude` - verifies Claude is never invoked

### Files changed
- src/ralph/commands/prd.py (modified)
- tests/test_commands/test_prd.py (modified)

### Learnings for future iterations
- Mutual exclusivity checks should happen early in the function, before any expensive operations
- Provide actionable guidance in error messages, not just the error description
- Test that no side effects occur (like Claude invocation) when validation fails

---

## 2026-01-17 - US-007

**Story:** Add file modification detection to ralph prd

### What was implemented
- Added `_get_file_mtime()` helper function to get file modification time (returns None if file doesn't exist)
- Added `_check_file_modified()` helper function to check if file was created/modified and display appropriate message
- Updated interactive mode to record mtime before Claude runs and check modification after
- Updated non-interactive mode to record mtime before Claude runs and check modification after
- Success message displayed when file is created or modified (mtime changed)
- Warning message displayed in yellow when file was not modified or not created
- Command exits with code 0 in both cases

### Tests written
- `TestGetFileMtime` class with 2 tests:
  - `test_returns_mtime_when_file_exists` - verifies mtime returned when file exists
  - `test_returns_none_when_file_not_exists` - verifies None returned when file doesn't exist
- `TestCheckFileModified` class with 4 tests:
  - `test_shows_success_when_file_created` - verifies success message when file is newly created
  - `test_shows_success_when_file_modified` - verifies success message when file mtime changes
  - `test_shows_warning_when_file_not_created` - verifies warning when file wasn't created
  - `test_shows_warning_when_file_not_modified` - verifies warning when file wasn't modified
- `TestPrdFileModificationDetection` class with 5 integration tests:
  - `test_prd_detects_file_modification_interactive` - verifies detection in interactive mode
  - `test_prd_detects_no_modification_interactive` - verifies no-modification detection in interactive mode
  - `test_prd_detects_file_modification_non_interactive` - verifies detection in non-interactive mode
  - `test_prd_detects_no_modification_non_interactive` - verifies no-modification detection in non-interactive mode
  - `test_prd_exits_zero_when_file_not_modified` - verifies exit code 0 even when not modified

### Files changed
- src/ralph/commands/prd.py (modified)
- tests/test_commands/test_prd.py (modified)

### Learnings for future iterations
- Use `os.path.getmtime()` to get file modification time as a float
- Compare mtime before and after operation to detect changes (mtime_after > mtime_before)
- Use `time.sleep(0.01)` in tests to ensure mtime changes between writes
- The warning message text changed from "was not created" to "was not modified" for clarity

---

## 2026-01-17 - US-008

**Story:** Integration tests for autonomous iteration

### What was implemented
- Created `tests/test_integration/__init__.py` module
- Created `tests/test_integration/test_autonomous_iteration.py` with comprehensive integration tests
- `TestClaudeServiceSkipPermissions` class: Tests that ClaudeService correctly handles skip_permissions parameter
- `TestOnceCommandAutonomousIteration` class: Integration tests for ralph once command
- `TestLoopCommandAutonomousIteration` class: Integration tests for ralph loop command
- `TestAutonomousIterationErrorHandling` class: Error handling tests for both commands

### Tests written
- `TestClaudeServiceSkipPermissions` (3 tests):
  - `test_skip_permissions_adds_flag_to_args` - verifies --dangerously-skip-permissions is added
  - `test_skip_permissions_false_does_not_add_flag` - verifies flag is omitted when False
  - `test_skip_permissions_flag_position_in_args` - verifies flag position in args
- `TestOnceCommandAutonomousIteration` (5 tests):
  - `test_once_invokes_claude_with_skip_permissions` - verifies flag passed to subprocess
  - `test_once_displays_autonomous_iteration_message` - verifies info message
  - `test_once_includes_print_flag` - verifies --print mode used
  - `test_once_passes_prompt_with_story_details` - verifies prompt content
  - `test_once_complete_workflow` - tests full completion flow
- `TestLoopCommandAutonomousIteration` (6 tests):
  - `test_loop_invokes_claude_with_skip_permissions` - verifies flag passed
  - `test_loop_displays_autonomous_iteration_message` - verifies info message
  - `test_loop_includes_print_flag` - verifies --print mode
  - `test_loop_runs_multiple_iterations_with_skip_permissions` - verifies flag across iterations
  - `test_loop_stops_on_complete_signal` - verifies COMPLETE signal detection
  - `test_loop_complete_workflow_with_multiple_stories` - tests multi-story completion
- `TestAutonomousIterationErrorHandling` (3 tests):
  - `test_once_handles_claude_not_found` - verifies error handling
  - `test_loop_handles_claude_not_found` - verifies error handling
  - `test_once_handles_nonzero_exit_code` - verifies exit code handling

### Files changed
- tests/test_integration/__init__.py (new)
- tests/test_integration/test_autonomous_iteration.py (new)

### Learnings for future iterations
- Use `patch.object(service, "_run_process")` to mock ClaudeService at method level for unit tests
- Use `patch("subprocess.Popen")` for integration tests that need to verify actual subprocess args
- When testing loop behavior with multiple iterations, read and update the TASKS.json file in the mock to simulate story completion
- Use `json.loads(file.read_text())` in mocks to read current file state rather than referencing fixture data directly

---

## 2026-01-17 - US-009

**Story:** Integration tests for ralph prd automation

### What was implemented
- Created `tests/test_integration/test_prd_automation.py` with comprehensive integration tests
- `TestPrdInputFlagIntegration` class: Tests for `ralph prd --input` flag
- `TestPrdFileFlagIntegration` class: Tests for `ralph prd --file` flag
- `TestPrdMutualExclusivityIntegration` class: Tests for mutual exclusivity of --input and --file
- `TestPrdAutomationCompleteWorkflow` class: End-to-end workflow tests

### Tests written
- `TestPrdInputFlagIntegration` (7 tests):
  - `test_prd_input_invokes_claude_in_print_mode` - verifies --print mode used
  - `test_prd_input_displays_non_interactive_header` - verifies header display
  - `test_prd_input_shows_feature_description` - verifies feature in output
  - `test_prd_input_includes_feature_in_prompt` - verifies feature in prompt
  - `test_prd_input_detects_file_modification` - verifies SPEC.md creation detection
  - `test_prd_input_handles_claude_error` - verifies error handling
  - `test_prd_input_handles_nonzero_exit_code` - verifies exit code handling
- `TestPrdFileFlagIntegration` (8 tests):
  - `test_prd_file_invokes_claude_in_print_mode` - verifies --print mode
  - `test_prd_file_displays_non_interactive_header` - verifies header display
  - `test_prd_file_reads_file_contents` - verifies file content used
  - `test_prd_file_error_when_file_not_exists` - verifies missing file error
  - `test_prd_file_error_when_file_empty` - verifies empty file error
  - `test_prd_file_strips_whitespace` - verifies whitespace handling
  - `test_prd_file_detects_file_modification` - verifies SPEC.md creation detection
  - `test_prd_file_handles_claude_error` - verifies error handling
- `TestPrdMutualExclusivityIntegration` (4 tests):
  - `test_prd_error_when_both_input_and_file_provided` - verifies error message
  - `test_prd_mutual_exclusivity_exits_nonzero` - verifies exit code 1
  - `test_prd_mutual_exclusivity_does_not_call_claude` - verifies Claude not invoked
  - `test_prd_mutual_exclusivity_shows_guidance` - verifies actionable guidance
- `TestPrdAutomationCompleteWorkflow` (3 tests):
  - `test_prd_input_complete_workflow_creates_spec` - end-to-end with --input
  - `test_prd_file_complete_workflow_creates_spec` - end-to-end with --file
  - `test_prd_input_updates_existing_spec` - verifies updating existing SPEC.md

### Files changed
- tests/test_integration/test_prd_automation.py (new)

### Learnings for future iterations
- Use `os.chdir()` with `try/finally` to ensure directory restoration in tests
- Mock `subprocess.Popen` with callbacks that simulate file creation for file modification detection tests
- Test both happy path (file created) and warning path (file not created) scenarios
- Integration tests should verify the prompt content by extracting from captured args

---

## 2026-01-18 - US-001

**Story:** Fix stream-json requires verbose flag

### What was implemented
- Added conditional `--verbose` flag in `run_print_mode()` when `stream=True`
- The stream-json output format requires the `--verbose` flag to work properly
- The code checks if `--verbose` is already in args to avoid duplication when `self.verbose=True`
- In non-verbose mode, stream-json is parsed and only text content is displayed (via existing `parse_json` logic)
- In verbose mode, full JSON stream is displayed (current behavior preserved)

### Tests written
- `test_includes_verbose_when_streaming` - verifies --verbose is always included when stream=True
- `test_excludes_verbose_when_not_streaming_and_not_verbose` - verifies --verbose is NOT included when stream=False and verbose=False
- `test_does_not_duplicate_verbose_when_already_set` - verifies --verbose is not duplicated when service.verbose=True and stream=True

### Files changed
- src/ralph/services/claude.py (modified)
- tests/test_services/test_claude.py (modified)

### Learnings for future iterations
- The `--output-format stream-json` requires `--verbose` flag when using `--print` mode
- Always check for existing flags in args before adding to avoid duplication (`"--verbose" not in args`)
- The existing `parse_json` logic in `_stream_output()` handles text display vs JSON display correctly

---

[Ralph Loop] 2026-01-18 01:41 UTC - Iteration 1: US-001 (Fix stream-json requires verbose flag) completed

---

## 2026-01-18 - US-002

**Story:** Add newlines between message blocks in output

### What was implemented
- Added `MESSAGE_BOUNDARY` constant (set to `"\n"`) in `src/ralph/services/claude.py`
- Modified `_parse_stream_event()` to detect message boundaries via `message_stop` and `result` event types
- When a message boundary is detected, the method returns `MESSAGE_BOUNDARY` (a newline)
- The `_stream_output()` method already writes returned text, so newlines are automatically added
- Inline text flow is preserved because `content_block_delta` events continue to return text without newlines

### Tests written
- `test_returns_message_boundary_for_message_stop` - verifies `message_stop` events return `MESSAGE_BOUNDARY`
- `test_returns_message_boundary_for_result` - verifies `result` events return `MESSAGE_BOUNDARY`
- `test_message_boundary_is_newline` - verifies `MESSAGE_BOUNDARY` is `"\n"`
- `TestStreamOutputMessageBoundary` class with 4 integration tests:
  - `test_stream_output_adds_newline_at_message_boundary` - verifies newline added after `message_stop`
  - `test_stream_output_adds_newline_at_result_boundary` - verifies newline added after `result`
  - `test_stream_output_preserves_inline_text_flow` - verifies text chunks concatenate without extra newlines
  - `test_stream_output_multiple_message_boundaries` - verifies multiple boundaries work correctly

### Files changed
- src/ralph/services/claude.py (modified)
- tests/test_services/test_claude.py (modified)

### Learnings for future iterations
- The stream-json format uses `message_stop` and `result` event types to indicate message boundaries
- Returning special sentinel values from parsing functions is a clean way to signal metadata to callers
- The existing `_stream_output()` code handles any returned string, so the newline is automatically written

---

[Ralph Loop] 2026-01-18 01:44 UTC - Iteration 2: US-002 (Add newlines between message blocks in output) completed

[Ralph Loop] 2026-01-18 01:45 UTC - Iteration 2: US-002 (Add newlines between message blocks in output) completed

## 2026-01-18 - US-003

**Story:** Enable skip permissions for ralph prd

### What was implemented
- Added `skip_permissions: bool = False` parameter to `run_interactive()` in `src/ralph/services/claude.py`
- When `skip_permissions=True`, `--dangerously-skip-permissions` flag is added to CLI args
- Updated `ralph prd` command to call `run_interactive()` with `skip_permissions=True`
- Added info message: "Running with auto-approved permissions for PRD creation"

### Tests written
- `TestRunInteractive` class extended with 4 new tests:
  - `test_includes_skip_permissions_when_true` - verifies flag is included when True
  - `test_excludes_skip_permissions_when_false` - verifies flag is NOT included when False
  - `test_default_skip_permissions_is_false` - verifies default behavior
  - `test_skip_permissions_with_prompt` - verifies flag works with prompt
- `TestPrdSkipPermissions` class (new) with 2 tests:
  - `test_prd_passes_skip_permissions_true` - verifies prd passes skip_permissions=True
  - `test_prd_displays_permissions_message` - verifies info message is displayed
- Fixed 2 existing tests to handle new skip_permissions parameter signature

### Files changed
- src/ralph/services/claude.py (modified)
- src/ralph/commands/prd.py (modified)
- tests/test_services/test_claude.py (modified)
- tests/test_commands/test_prd.py (modified)

### Learnings for future iterations
- When adding parameters to `run_interactive()`, use `*` to make them keyword-only: `def run_interactive(self, prompt: str | None = None, *, skip_permissions: bool = False)`
- Tests using `side_effect` functions must match the new method signature (accept `skip_permissions` kwarg)
- Info messages about permissions should be displayed before launching Claude for user awareness

---

[Ralph Loop] 2026-01-18 01:49 UTC - Iteration 3: US-003 (Enable skip permissions for ralph prd) completed

## 2026-01-18 - US-004

**Story:** Create CHANGELOG.md on ralph init

### What was implemented
- Added `create_changelog()` method to ScaffoldService in `scaffold.py`
- Template follows Keep a Changelog format with reference link
- Template includes Unreleased section with all 6 standard category headers:
  - Added, Changed, Deprecated, Removed, Fixed, Security
- Updated `scaffold_all()` to include changelog in created files
- Updated `init_cmd.py` to preserve existing CHANGELOG.md content (never overwrite)
- Added CHANGELOG.md to `_check_existing_files()` check list
- Shows "Skipped CHANGELOG.md (already exists)" message when changelog exists

### Tests written
- `TestCreateChangelog` class (4 tests):
  - `test_creates_changelog_file` - verifies CHANGELOG.md is created
  - `test_changelog_follows_keep_a_changelog_format` - verifies format reference
  - `test_changelog_has_unreleased_section` - verifies Unreleased section exists
  - `test_changelog_has_category_headers` - verifies all 6 category headers
- `TestScaffoldAll` tests updated to include changelog assertions
- `TestCheckExistingFiles` tests updated to include CHANGELOG.md
- `TestInitChangelogCreation` class (5 tests):
  - `test_init_creates_changelog_md` - verifies file is created
  - `test_init_changelog_follows_keep_a_changelog_format` - verifies format
  - `test_init_changelog_has_unreleased_section` - verifies section/headers
  - `test_init_does_not_overwrite_existing_changelog` - verifies preservation
  - `test_init_shows_skipped_message_for_existing_changelog` - verifies output

### Files changed
- src/ralph/services/scaffold.py (modified - added create_changelog method)
- src/ralph/commands/init_cmd.py (modified - preserve existing changelog)
- tests/test_services/test_scaffold.py (modified - added changelog tests)
- tests/test_commands/test_init_cmd.py (modified - added changelog tests)

### Learnings for future iterations
- CHANGELOG.md is treated as persistent memory and should never be overwritten even with --force
- Save content before scaffold_all() and restore after to preserve existing file
- Keep a Changelog format uses section headers in order: Added, Changed, Deprecated, Removed, Fixed, Security

---

[Ralph Loop] 2026-01-18 01:53 UTC - Iteration 4: US-004 (Create CHANGELOG.md on ralph init) completed

## 2026-01-18 - US-005

**Story:** Add CHANGELOG guidelines to CLAUDE.md and AGENTS.md

### What was implemented
- Added CHANGELOG.md section to CLAUDE.md template in scaffold.py
- Added identical CHANGELOG.md section to AGENTS.md template (kept in sync)
- Guidelines specify when to update: features, bug fixes, breaking changes, performance, security, deprecations
- Guidelines specify when NOT to update: refactoring, tests, docs, formatting, deps, WIP commits
- Guidelines specify how to update: Unreleased section, appropriate categories, user perspective, concise but specific

### Tests written
- No new tests needed - existing scaffold tests cover template generation
- All 499 tests pass with the updated template content

### Files changed
- src/ralph/services/scaffold.py (modified - added CHANGELOG.md section to both templates)

### Learnings for future iterations
- Template sections in CLAUDE.md and AGENTS.md must be kept in sync - duplicate the content verbatim
- CHANGELOG guidelines serve as persistent memory for Claude about what changes to document
- The guidelines distinguish user-facing changes (log) from internal changes (don't log)

---

[Ralph Loop] 2026-01-18 - Iteration 5: US-005 (Add CHANGELOG guidelines to CLAUDE.md and AGENTS.md) completed

[Ralph Loop] 2026-01-18 01:58 UTC - Iteration 5: US-005 (Add CHANGELOG guidelines to CLAUDE.md and AGENTS.md) completed

## 2026-01-18 - US-006

**Story:** Update iteration prompt for CHANGELOG

### What was implemented
- Added CHANGELOG.md to Phase 4 (Completion) step list in ralph-iteration/SKILL.md
- Added dedicated "CHANGELOG.md" subsection under "Updating Memory Files"
- Section includes:
  - "When to Update" with 6 categories: new features, bug fixes, breaking changes, performance, security, deprecations
  - "When NOT to Update" with 6 categories: refactoring, tests, docs, formatting, deps, WIP commits
  - "How to Update" with step-by-step guidance and example entry
- Added CHANGELOG.md to File Reference table at end of skill

### Tests written
- No Python tests needed (skill is a markdown instruction file)
- Format validated by existing SkillsService tests (validates frontmatter parsing)

### Files changed
- skills/ralph-iteration/SKILL.md (modified - added CHANGELOG guidance)

### Learnings for future iterations
- Skills are markdown files that guide Claude through workflows - they don't need code tests
- CHANGELOG guidelines in skill should mirror guidelines in CLAUDE.md/AGENTS.md templates
- Include concrete examples (like the markdown entry example) for better guidance

---


[Ralph Loop] 2026-01-18 02:00 UTC - Iteration 6: US-006 (Update iteration prompt for CHANGELOG) completed

## 2026-01-18 - US-007

**Story:** Archive PROGRESS.txt on new task generation

### What was implemented
- Added `_archive_progress_file()` helper function in `src/ralph/commands/tasks.py`
- Archives existing PROGRESS.txt to `plans/PROGRESS.{timestamp}.txt` format (YYYYMMDD_HHMMSS)
- Creates fresh PROGRESS.txt with standard header template after archiving
- Added `PROGRESS_TEMPLATE` constant matching the scaffold.py template
- Archives only if PROGRESS.txt exists and has non-whitespace content
- Displays message "Archived previous progress to PROGRESS.{timestamp}.txt" after archiving
- Integrated archival into tasks command - runs after TASKS.json is successfully written

### Tests written
- `TestArchiveProgressFile` class with 7 tests:
  - `test_returns_none_if_progress_does_not_exist` - verifies no archival when file missing
  - `test_returns_none_if_progress_is_empty` - verifies no archival for empty file
  - `test_returns_none_if_progress_only_whitespace` - verifies whitespace-only handling
  - `test_archives_existing_progress_file` - verifies content is archived correctly
  - `test_archive_uses_correct_timestamp_format` - verifies YYYYMMDD_HHMMSS pattern
  - `test_creates_fresh_progress_with_template` - verifies new template is written
  - `test_fresh_progress_has_expected_sections` - verifies required sections
- `TestTasksCommandProgressArchival` class with 5 integration tests:
  - `test_tasks_archives_progress_file` - end-to-end archival test
  - `test_tasks_displays_archive_message` - verifies output message
  - `test_tasks_creates_fresh_progress_file` - verifies fresh template
  - `test_tasks_does_not_archive_empty_progress` - verifies empty file handling
  - `test_tasks_does_not_archive_nonexistent_progress` - verifies missing file handling

### Files changed
- src/ralph/commands/tasks.py (modified - added archival logic and helper)
- tests/test_commands/test_tasks.py (modified - added 12 new tests)

### Learnings for future iterations
- Use `datetime.now(UTC)` instead of `datetime.now(timezone.utc)` for ruff UP017 compliance
- Use `shutil.copy2()` to preserve file metadata when archiving
- Check for both file existence AND content before archiving to avoid empty archives
- The PROGRESS_TEMPLATE should match scaffold.py's `create_progress_placeholder()` exactly

---

[Ralph Loop] 2026-01-18 UTC - Iteration 7: US-007 (Archive PROGRESS.txt on new task generation) completed

[Ralph Loop] 2026-01-18 02:04 UTC - Iteration 7: US-007 (Archive PROGRESS.txt on new task generation) completed

## 2026-01-18 - US-008

**Story:** Enable streaming for ralph tasks

### What was implemented
- Changed `stream=False` to `stream=True` in `run_print_mode()` call in `tasks.py`
- Users now see Claude's progress in real-time as it generates the task breakdown
- JSON extraction continues to work correctly because `ClaudeService._stream_output()` extracts text content from stream-json events and returns it as plain text, which `_extract_json()` can parse normally

### Tests written
- `TestTasksCommandStreaming` class with 4 tests:
  - `test_tasks_streaming_extracts_json_from_text_output` - verifies JSON extraction works with streamed output
  - `test_tasks_streaming_handles_json_in_code_block` - verifies extraction handles code blocks
  - `test_tasks_streaming_handles_text_with_embedded_json` - verifies extraction handles embedded JSON in text
  - `test_tasks_streaming_shows_progress_during_generation` - verifies "Running Claude" message is displayed
- Updated `test_tasks_launches_claude_in_print_mode_with_streaming` to verify `stream=True` is passed

### Files changed
- src/ralph/commands/tasks.py (modified - changed stream=False to stream=True)
- tests/test_commands/test_tasks.py (modified - added 4 new streaming tests, updated 1 existing test)

### Learnings for future iterations
- When streaming is enabled, `ClaudeService` parses stream-json events and extracts text content, returning clean text that can be processed by `_extract_json()`
- The existing `_extract_json()` function already handles multiple formats (pure JSON, code blocks, embedded JSON) which works seamlessly with streamed output
- No changes needed to JSON extraction logic - the abstraction in `ClaudeService` keeps the command code simple

---

[Ralph Loop] 2026-01-18 UTC - Iteration 8: US-008 (Enable streaming for ralph tasks) completed

[Ralph Loop] 2026-01-18 02:07 UTC - Iteration 8: US-008 (Enable streaming for ralph tasks) completed

## 2026-01-18 - US-009

**Story:** Add unit tests for bug fixes

### What was implemented
- Created `tests/test_bug_fixes.py` with comprehensive unit tests for v1.2 bug fixes
- `TestBuildBaseArgsStreamingVerbose` class (6 tests): Tests for verbose flag when streaming
- `TestParseStreamEventNewlineMarkers` class (8 tests): Tests for newline marker behavior
- `TestRunInteractiveSkipPermissions` class (6 tests): Tests for skip_permissions parameter
- `TestProgressArchivalTimestampFormat` class (9 tests): Tests for PROGRESS.txt archival
- `TestBugFixesIntegration` class (2 tests): Integration tests verifying components work together

### Tests written
- 31 new tests covering all acceptance criteria:
  - `test_verbose_included_when_streaming_enabled` - Core bug fix test
  - `test_verbose_not_duplicated_when_service_verbose_true` - No duplication
  - `test_message_stop_returns_newline_marker` - Message boundary detection
  - `test_result_event_returns_newline_marker` - Result event boundary
  - `test_skip_permissions_adds_flag_when_true` - Flag added correctly
  - `test_archive_creates_file_with_timestamp_format` - YYYYMMDD_HHMMSS format
  - `test_archive_timestamp_is_valid_datetime` - Valid datetime validation
  - Plus 24 more tests for edge cases and error conditions

### Files changed
- tests/test_bug_fixes.py (new - 480 lines)
- plans/TASKS.json (updated - marked US-009 as passed)

### Learnings for future iterations
- Group bug fix tests in a dedicated test module for clarity and maintainability
- Include integration tests that verify multiple bug fixes work together
- Test timestamp parsing validates actual datetime format, not just regex pattern
- Testing MESSAGE_BOUNDARY constant ensures it remains a newline character

---

[Ralph Loop] 2026-01-18 UTC - Iteration 9: US-009 (Add unit tests for bug fixes) completed

[Ralph Loop] 2026-01-18 02:10 UTC - Iteration 9: US-009 (Add unit tests for bug fixes) completed
## 2026-01-18 - US-010

**Story:** Add integration tests for commands

### What was implemented
- Created `tests/test_integration/test_command_integration.py` with comprehensive integration tests
- `TestOnceCommandWithoutVerboseFlag` class (4 tests): Tests ralph once runs without -v flag
- `TestLoopCommandWithoutVerboseFlag` class (4 tests): Tests ralph loop runs without -v flag
- `TestTasksCommandStreaming` class (3 tests): Tests ralph tasks uses streaming output
- `TestInitCommandChangelogCreation` class (5 tests): Tests ralph init creates CHANGELOG.md
- `TestMessageBoundaryNewlines` class (1 test): Tests newlines at message boundaries
- `TestSkipPermissionsIntegration` class (2 tests): Tests skip_permissions for ralph prd
- Fixed line length issues in test_bug_fixes.py to satisfy ruff E501

### Tests written
- 19 new integration tests covering all acceptance criteria:
  - `test_once_runs_without_verbose_flag_no_crash` - Core test for streaming bug fix
  - `test_once_without_verbose_uses_stream_json_format` - Verifies stream-json format
  - `test_loop_runs_without_verbose_flag_no_crash` - Loop command no-crash test
  - `test_loop_without_verbose_uses_stream_json_format` - Loop stream-json test
  - `test_tasks_streams_output` - Verifies stream=True in run_print_mode
  - `test_tasks_streaming_extracts_json_successfully` - JSON extraction with streaming
  - `test_init_creates_changelog_md` - CHANGELOG.md creation verification
  - `test_init_changelog_has_keep_a_changelog_format` - Format verification
  - `test_init_changelog_has_all_category_headers` - Category headers verification
  - `test_init_preserves_existing_changelog` - Preservation test
  - Plus 9 more tests for verbose flags, code blocks, message boundaries, and prd permissions

### Files changed
- tests/test_integration/test_command_integration.py (new - 787 lines)
- tests/test_bug_fixes.py (modified - fixed line length issues)

### Learnings for future iterations
- Use string concatenation to break long JSON strings: `event = ('{"type":"a",' '"data":"b"}')`
- Integration tests should verify both crash-free operation and correct behavior
- When testing streaming, mock Popen to return StringIO or iter() for stdout
- Use `result.exit_code in (0, 1)` to allow both success and story-not-passed outcomes

---

[Ralph Loop] 2026-01-18 UTC - Iteration 10: US-010 (Add integration tests for commands) completed

## 2026-01-18 - Issue #6 Fix (v1.2.1)

**Issue:** Output formatting - newlines not appearing between Claude's thoughts

### Root Cause
The original fix (US-002) detected `message_stop` and `result` events to add newlines, but these events only fire at the end of the entire message. Multiple Claude "thoughts" within the same message are separate **content blocks**, separated by `content_block_stop` events that were not being detected.

### What was implemented
- Added `content_block_stop` to the event types that trigger `MESSAGE_BOUNDARY` in `_parse_stream_event()`
- Updated comments to explain the three event types:
  - `content_block_stop`: fires after each content block (text, tool_use)
  - `message_stop`: fires at the end of the entire message
  - `result`: fires at the end of the conversation

### Tests written
- `test_returns_message_boundary_for_content_block_stop` - verifies content_block_stop returns MESSAGE_BOUNDARY
- `test_stream_output_adds_newline_at_content_block_stop` - verifies newlines between content blocks
- Updated `TestParseStreamEventNewlineMarkers` docstring to reference Issue #6
- Added integration test `test_stream_output_writes_newline_at_content_block_stop` in test_bug_fixes.py

### Files changed
- src/ralph/services/claude.py (modified - added content_block_stop detection)
- tests/test_services/test_claude.py (modified - added 2 new tests)
- tests/test_bug_fixes.py (modified - added 2 new tests, updated docstrings)
- pyproject.toml (modified - bumped version to 1.2.1)
- src/ralph/__init__.py (modified - bumped __version__ to 1.2.1)

### Expected output after fix
```
I'm on the correct branch. Let me check the project.
Now let me start implementing US-001.
Now let me add the dependencies.
```

Each content block now ends with a newline, making output readable.

---

