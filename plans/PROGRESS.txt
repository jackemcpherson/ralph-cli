# Ralph Progress Log

## Codebase Patterns

- Use `create_console()` from `ralph.utils.console` for consistent Windows encoding handling
- When mocking `sys.platform` for Windows tests, use `"win32"` (not `"windows"`)
- Normalize encoding strings by lowercasing and removing hyphens for comparison (e.g., `"UTF-8"` -> `"utf8"`)
- Use `normalize_paths()` from `tests.conftest` or the `path_normalizer` fixture for cross-platform path comparison in tests
- Use raw docstrings (`r"""..."""`) when the docstring contains backslash characters to avoid ruff D301 lint errors

---

## Log

(Iteration entries will be appended below)

---

## 2026-01-20 - US-001

**Story:** Windows encoding detection for Rich console

### What was implemented
- Created `create_console()` function in `src/ralph/utils/console.py` that detects Windows legacy encodings
- Added `LEGACY_WINDOWS_ENCODINGS` constant containing `cp1252`, `cp437`, and `ascii`
- Console now uses `legacy_windows=True` for legacy encodings on Windows platform
- Console uses default settings for UTF-8 terminals and non-Windows platforms
- Encoding detection handles edge cases: missing encoding attribute, None encoding, various UTF-8 case variations

### Tests written
- `TestCreateConsole` class with 10 test cases:
  - `test_returns_console_instance` - Verifies function returns Console
  - `test_legacy_encodings_constant` - Verifies constant contains expected encodings
  - `test_windows_legacy_encoding_enables_legacy_mode` - Parametrized test for cp1252, cp437, ascii
  - `test_windows_utf8_encoding_uses_default` - Parametrized test for utf-8 variations
  - `test_non_windows_platform_uses_default` - Verifies macOS uses default
  - `test_linux_platform_uses_default` - Verifies Linux uses default
  - `test_missing_encoding_attribute_defaults_to_utf8` - Edge case handling
  - `test_none_encoding_defaults_to_utf8` - Edge case handling
  - `test_encoding_normalization_removes_hyphen` - Verifies UTF-8 normalization

### Files changed
- `src/ralph/utils/console.py` - Added `create_console()` function and `LEGACY_WINDOWS_ENCODINGS` constant
- `tests/test_utils/test_console.py` - Added `TestCreateConsole` test class with encoding scenarios

### Learnings for future iterations
- Rich Console's `legacy_windows` parameter disables Unicode characters that may fail on legacy Windows terminals
- Python's `sys.stdout.encoding` may be None in some environments, so always provide a fallback
- Use `MagicMock(spec=[])` to create a mock without an `encoding` attribute for testing edge cases

---

[Ralph CLI] 2026-01-20 03:01 UTC - US-001 (Windows encoding detection for Rich console) completed successfully

## 2026-01-20 - US-002

**Story:** Update codebase to use centralized console

### What was implemented
- Verified that all modules already import console from `ralph.utils.console` (established in US-001)
- Verified no direct `Console()` instantiation exists outside of `create_console()`
- Added enforcement tests to prevent future regressions of the centralized console pattern

### Tests written
- `TestCentralizedConsolePattern` class with 3 test cases:
  - `test_no_direct_console_instantiation_outside_create_console` - AST-based analysis that scans all Python files in `src/ralph/` and fails if `Console()` is called outside of `create_console()`
  - `test_console_module_exports_shared_instance` - Verifies the shared console instance is exported
  - `test_utils_init_re_exports_console` - Verifies `ralph.utils` re-exports the same console instance

### Files changed
- `tests/test_utils/test_console.py` - Added `TestCentralizedConsolePattern` test class

### Learnings for future iterations
- Use Python's `ast` module to enforce code patterns in tests (more reliable than regex)
- The codebase was already compliant from US-001, so this story focused on enforcement
- AST node's `end_lineno` attribute helps determine if code is inside a function

---

[Ralph Loop] 2026-01-20 03:36 UTC - Iteration 1: US-002 (Update codebase to use centralized console) completed

## 2026-01-20 - US-003

**Story:** Path normalization test utility

### What was implemented
- Added `normalize_paths()` function to `tests/conftest.py` that converts backslashes to forward slashes
- Added `path_normalizer` pytest fixture that returns the `normalize_paths` function
- Function and fixture are both available for cross-platform path comparison in tests

### Tests written
- `TestNormalizePaths` class with 9 test cases:
  - `test_converts_single_backslash` - Single backslash conversion
  - `test_converts_multiple_backslashes` - Multiple backslash conversion
  - `test_handles_windows_absolute_path` - Windows paths like `C:\Users\...`
  - `test_preserves_forward_slashes` - Forward slashes unchanged
  - `test_handles_mixed_separators` - Mixed forward/backslash handling
  - `test_handles_empty_string` - Edge case for empty input
  - `test_handles_no_path_separators` - Plain filenames unchanged
  - `test_handles_double_backslashes` - Double backslash handling
  - `test_handles_trailing_backslash` - Trailing backslash handling
- `TestPathNormalizerFixture` class with 3 test cases:
  - `test_fixture_returns_normalize_paths_function` - Fixture returns correct function
  - `test_fixture_can_be_used_for_normalization` - Fixture works for simple paths
  - `test_fixture_works_with_complex_paths` - Fixture handles complex Windows paths

### Files changed
- `tests/conftest.py` - Added `normalize_paths()` function and `path_normalizer` fixture
- `tests/test_utils/test_conftest_utils.py` - New test file for conftest utilities

### Learnings for future iterations
- Use raw docstring (`r"""..."""`) when docstring contains backslash examples to avoid ruff D301 lint error
- The `normalize_paths` function can be imported directly from `tests.conftest` or used via the `path_normalizer` fixture

---

[Ralph Loop] 2026-01-20 - Iteration 2: US-003 (Path normalization test utility) completed
