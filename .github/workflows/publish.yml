name: Publish

on:
  push:
    tags: ['v*']

permissions:
  id-token: write
  contents: write

jobs:
  ci-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Wait for CI workflow to succeed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          commit_sha="${GITHUB_SHA}"
          repo="${GITHUB_REPOSITORY}"
          workflow_name="CI"
          max_attempts=30
          wait_seconds=30

          echo "Checking CI workflow status for commit ${commit_sha}..."

          for attempt in $(seq 1 "$max_attempts"); do
            # Query CI workflow runs for this exact commit
            run_data=$(gh api "repos/${repo}/actions/workflows/ci.yml/runs?head_sha=${commit_sha}&per_page=1" \
              --jq '.workflow_runs[0] // empty')

            if [ -z "$run_data" ]; then
              if [ "$attempt" -eq "$max_attempts" ]; then
                echo "::error::CI workflow has not run for commit ${commit_sha}. Ensure CI is triggered before publishing."
                exit 1
              fi
              echo "Attempt ${attempt}/${max_attempts}: CI workflow not found yet. Waiting ${wait_seconds}s..."
              sleep "$wait_seconds"
              continue
            fi

            status=$(echo "$run_data" | jq -r '.status')
            conclusion=$(echo "$run_data" | jq -r '.conclusion')
            run_url=$(echo "$run_data" | jq -r '.html_url')

            echo "CI run: status=${status}, conclusion=${conclusion}"
            echo "  URL: ${run_url}"

            if [ "$status" = "completed" ]; then
              if [ "$conclusion" = "success" ]; then
                echo "CI workflow passed for commit ${commit_sha}."
                exit 0
              else
                echo "::error::CI workflow failed for commit ${commit_sha} (conclusion: ${conclusion}). See: ${run_url}"
                exit 1
              fi
            fi

            if [ "$attempt" -eq "$max_attempts" ]; then
              echo "::error::CI workflow still running after $((max_attempts * wait_seconds))s. See: ${run_url}"
              exit 1
            fi

            echo "Attempt ${attempt}/${max_attempts}: CI still running (status=${status}). Waiting ${wait_seconds}s..."
            sleep "$wait_seconds"
          done

  build:
    needs: ci-check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Build package
        run: uv build

      - name: Upload dist artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: python-package-distributions
          path: dist/

  testpypi:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: testpypi
      url: https://test.pypi.org/p/ralph-cli
    permissions:
      id-token: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          repository-url: https://test.pypi.org/legacy/

  pypi:
    needs: testpypi
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: pypi
      url: https://pypi.org/p/ralph-cli
    permissions:
      id-token: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0

  release:
    needs: pypi
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.2

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Extract release notes from CHANGELOG.md
        id: notes
        run: |
          version="${{ steps.version.outputs.version }}"
          # Extract content between this version header and the next version header
          awk "/^## \\[${version}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" CHANGELOG.md > release_notes.txt
          # Remove leading/trailing blank lines
          sed -i '/./,$!d' release_notes.txt
          sed -i -e :a -e '/^\n*$/{$d;N;ba' -e '}' release_notes.txt

      - name: Download dist artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: python-package-distributions
          path: dist/

      - name: Determine pre-release flag
        id: prerelease
        run: |
          version="${{ steps.version.outputs.version }}"
          if echo "$version" | grep -qE '(a|b|rc|dev|alpha|beta|pre)'; then
            echo "flag=--prerelease" >> "$GITHUB_OUTPUT"
          else
            echo "flag=--latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file release_notes.txt \
            ${{ steps.prerelease.outputs.flag }} \
            dist/*
