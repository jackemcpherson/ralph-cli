# Ralph Progress Log

## Codebase Patterns

- Use Pydantic `BaseModel` for service classes with `ConfigDict(arbitrary_types_allowed=True)` when fields use Path
- Custom exceptions should have docstrings for both the class and `__init__` method (ruff D107)
- Run `uv run ruff format` after making changes, as format check is strict
- When constructing Pydantic models with aliases, use the alias name (e.g., `Manifest(syncedAt=...)` not `Manifest(synced_at=...)`)
- When refactoring commands to use skills, create `_build_prompt_from_skill()` that loads skill content via `SkillLoader` and appends context section

---

## Log

(Iteration entries will be appended below)

---

## 2026-01-21 - US-001

**Story:** Create SkillLoader service

### What was implemented
- Created `SkillLoader` Pydantic model in `src/ralph/services/skill_loader.py`
- Implemented `load(skill_name)` method that reads from `skills/{skill_name}/SKILL.md`
- Created `SkillNotFoundError` exception with clear error message including skill name and expected path
- Exported both classes from `src/ralph/services/__init__.py`

### Tests written
- `test_exception_message` - Verifies SkillNotFoundError has clear error message
- `test_exception_attributes` - Verifies exception stores skill_name and skill_path
- `test_init_with_path` - Verifies SkillLoader initializes with skills_dir
- `test_load_existing_skill` - Verifies load returns content for existing skill
- `test_load_raises_for_missing_skill_directory` - Verifies error for missing skill
- `test_load_raises_for_missing_skill_md` - Verifies error when SKILL.md is missing
- `test_load_raises_for_nonexistent_skills_dir` - Verifies error when skills_dir doesn't exist
- `test_load_returns_full_content` - Verifies full content including UTF-8 characters
- `test_load_multiple_skills` - Verifies loader can load multiple different skills

### Files changed
- `src/ralph/services/skill_loader.py` (new)
- `src/ralph/services/__init__.py` (updated exports)
- `tests/test_services/test_skill_loader.py` (new)

### Learnings for future iterations
- Service pattern uses Pydantic BaseModel with ConfigDict for Path fields
- Exception classes need docstrings on both class and __init__ to pass ruff lint
- Format check is strict - always run `uv run ruff format` after changes

---

[Ralph Loop] 2026-01-21 08:54 UTC - Iteration 1: US-001 (Create SkillLoader service) completed

---

## 2026-01-21 - US-002

**Story:** Add Manifest model for skill tracking

### What was implemented
- Created `Manifest` Pydantic model in `src/ralph/models/manifest.py`
- Model has `installed` field (list of skill directory names) with empty list default
- Model has `synced_at` field (ISO timestamp string) with `syncedAt` camelCase alias
- Created `load_manifest(path)` function that returns Manifest or None if file doesn't exist
- Created `save_manifest(manifest, path)` function that serializes to JSON with aliases
- Exported all from `src/ralph/models/__init__.py`

### Tests written
- `test_manifest_valid_with_all_fields` - Verifies model accepts all fields
- `test_manifest_empty_installed_list` - Verifies empty installed list works
- `test_manifest_installed_defaults_to_empty` - Verifies default is empty list
- `test_manifest_camel_case_alias` - Verifies syncedAt alias works
- `test_manifest_serialization_uses_alias` - Verifies JSON output uses camelCase
- `test_manifest_missing_required_synced_at` - Verifies validation error
- `test_manifest_with_many_skills` - Verifies handling of many skills
- `test_load_manifest_valid_file` - Verifies file loading
- `test_load_manifest_nonexistent_file` - Verifies None for missing file
- `test_load_manifest_with_empty_installed` - Verifies empty list loading
- `test_save_manifest_creates_file` - Verifies file creation
- `test_save_manifest_writes_valid_json` - Verifies JSON output
- `test_save_manifest_uses_camel_case_alias` - Verifies alias in output
- `test_save_and_load_round_trip` - Verifies round-trip serialization

### Files changed
- `src/ralph/models/manifest.py` (new)
- `src/ralph/models/__init__.py` (updated exports)
- `tests/test_models.py` (added Manifest tests)

### Learnings for future iterations
- Don't create a test directory with same name as existing test file (e.g., test_models/ conflicts with test_models.py)
- Follow existing model patterns: ConfigDict, alias with populate_by_name, by_alias in model_dump_json

---

[Ralph Loop] 2026-01-21 19:56 UTC - Iteration 2: US-002 (Add Manifest model for skill tracking) completed

[Ralph Loop] 2026-01-21 08:57 UTC - Iteration 2: US-002 (Add Manifest model for skill tracking) completed

---

## 2026-01-21 - US-003

**Story:** Enhance SkillsService with manifest support

### What was implemented
- Enhanced `SkillsService.sync_all()` to write a manifest file after syncing all skills
- Added `_write_manifest(results)` private method that extracts successfully installed skill names
- Manifest is written to `{target_dir}/.ralph-manifest.json` (defaults to `~/.claude/skills/.ralph-manifest.json`)
- Manifest contains list of installed skill directory names (sorted alphabetically)
- Manifest includes ISO timestamp in `syncedAt` field

### Tests written
- `test_sync_all_writes_manifest_file` - Verifies manifest file is created
- `test_manifest_contains_installed_skill_names` - Verifies installed list contains skill directory names
- `test_manifest_contains_synced_at_timestamp` - Verifies syncedAt timestamp is present
- `test_manifest_excludes_invalid_skills` - Verifies only successfully synced skills are in manifest
- `test_manifest_empty_for_no_valid_skills` - Verifies empty installed list when no valid skills
- `test_manifest_updated_on_subsequent_sync` - Verifies manifest is updated on re-sync
- `test_manifest_uses_source_directory_names` - Verifies directory names (not frontmatter names) are used

### Files changed
- `src/ralph/services/skills.py` (added manifest support)
- `tests/test_services/test_skills.py` (added TestManifestWriting class with 7 tests)

### Learnings for future iterations
- When using Pydantic models with aliases (e.g., `synced_at` with alias `syncedAt`), use the alias name when constructing the model (e.g., `Manifest(syncedAt=...)` not `Manifest(synced_at=...)`)

---

[Ralph Loop] 2026-01-21 - Iteration 3: US-003 (Enhance SkillsService with manifest support) completed

[Ralph Loop] 2026-01-21 09:00 UTC - Iteration 3: US-003 (Enhance SkillsService with manifest support) completed

---

## 2026-01-21 - US-004

**Story:** Implement ralph sync --remove

### What was implemented
- Added `remove_skills()` method to `SkillsService` that reads manifest and deletes listed skill directories
- Added `--remove/-r` flag to `ralph sync` command
- Created `_handle_remove()` helper function in sync.py for handling remove logic
- Operation is idempotent - returns empty list if no manifest exists or skills already removed
- Manifest file is deleted after cleanup
- Never deletes skills not listed in the manifest

### Tests written
- `test_remove_returns_empty_when_no_manifest` - Verifies empty list when no manifest exists
- `test_remove_deletes_manifest_skills` - Verifies skills listed in manifest are deleted
- `test_remove_deletes_manifest_file` - Verifies manifest file itself is deleted
- `test_remove_is_idempotent` - Verifies no error when skills already removed
- `test_remove_never_deletes_non_manifest_skills` - Verifies user skills are preserved
- `test_remove_after_sync_round_trip` - Verifies full sync then remove workflow
- `test_remove_returns_only_actually_removed` - Verifies only actually removed skills are returned

### Files changed
- `src/ralph/services/skills.py` (added remove_skills method)
- `src/ralph/commands/sync.py` (added --remove flag and _handle_remove helper)
- `tests/test_services/test_skills.py` (added TestRemoveSkills class with 7 tests)

### Learnings for future iterations
- When adding a new flag to a Typer command, create the service early in the function so it can be used by both code paths
- Helper functions for distinct operations (like _handle_remove) keep the main command function cleaner

---

[Ralph Loop] 2026-01-21 - Iteration 4: US-004 (Implement ralph sync --remove) completed

[Ralph Loop] 2026-01-21 09:04 UTC - Iteration 4: US-004 (Implement ralph sync --remove) completed

---

## 2026-01-21 - US-005

**Story:** Refactor ralph prd to use skill loading

### What was implemented
- Replaced `_build_prd_prompt()` and `_build_non_interactive_prd_prompt()` functions with `_build_prompt_from_skill()`
- New function uses `SkillLoader` to load `ralph-prd` skill content from `skills/ralph-prd/SKILL.md`
- Injects context (output path, mode, feature description) into the loaded skill content
- Added `SkillNotFoundError` handling with clear error message if skill is missing
- Removed all embedded prompt template strings from prd.py

### Tests written
- Updated `TestBuildPrdPrompt` class to `TestBuildPromptFromSkill` with new tests:
  - `test_prompt_includes_output_path` - Verifies output path is in prompt
  - `test_prompt_loads_skill_content` - Verifies skill content is loaded
  - `test_prompt_includes_context_section` - Verifies context section is added
  - `test_interactive_mode_asks_questions` - Verifies interactive mode prompts user
  - `test_raises_when_skill_not_found` - Verifies SkillNotFoundError raised
- Updated `TestBuildNonInteractivePrdPrompt` class to `TestBuildPromptFromSkillNonInteractive`
- Added `test_prd_handles_skill_not_found` test to TestPrdCommand
- Updated integration tests to create skill fixtures

### Files changed
- `src/ralph/commands/prd.py` (refactored to use SkillLoader)
- `tests/test_commands/test_prd.py` (updated test classes and fixtures)
- `tests/test_integration/test_prd_automation.py` (added skill fixture creation)
- `tests/test_integration/test_command_integration.py` (added skill fixture for prd tests)

### Learnings for future iterations
- When refactoring commands to use skills, tests need skill fixtures (directory with SKILL.md)
- Integration tests in separate files may have their own fixtures that need updating
- The pattern for skill-based commands: load skill, add context section, pass combined prompt to Claude

---

[Ralph Loop] 2026-01-21 - Iteration 5: US-005 (Refactor ralph prd to use skill loading) completed

[Ralph Loop] 2026-01-21 09:09 UTC - Iteration 5: US-005 (Refactor ralph prd to use skill loading) completed

---

## 2026-01-21 - US-006

**Story:** Refactor ralph tasks to use skill loading

### What was implemented
- Replaced `_build_tasks_prompt()` function with `_build_prompt_from_skill()`
- New function uses `SkillLoader` to load `ralph-tasks` skill content from `skills/ralph-tasks/SKILL.md`
- Injects context (spec content, branch name) into the loaded skill content
- Added `SkillNotFoundError` handling with clear error message if skill is missing
- Removed all embedded prompt template strings from tasks.py

### Tests written
- Updated `TestBuildTasksPrompt` class to `TestBuildPromptFromSkill` with new tests:
  - `test_prompt_includes_spec_content` - Verifies spec content is in prompt
  - `test_prompt_loads_skill_content` - Verifies skill content is loaded
  - `test_prompt_includes_context_section` - Verifies context section is added
  - `test_prompt_with_custom_branch_name` - Verifies branch name is in prompt
  - `test_prompt_without_branch_name` - Verifies derive instruction when no branch
  - `test_prompt_asks_for_json_only` - Verifies JSON output instruction
  - `test_raises_when_skill_not_found` - Verifies SkillNotFoundError raised
- Added `test_tasks_handles_skill_not_found` test to TestTasksCommand
- Updated integration test fixtures to include ralph-tasks skill

### Files changed
- `src/ralph/commands/tasks.py` (refactored to use SkillLoader)
- `tests/test_commands/test_tasks.py` (updated test classes and fixtures)
- `tests/test_integration/test_command_integration.py` (updated project_with_spec fixture)

### Learnings for future iterations
- Same pattern as prd.py: load skill, build context section, return concatenated prompt
- Test fixtures need to be updated consistently across test files
- Using sed with global replace can cause double-replacement issues - be careful with variable naming

---

[Ralph Loop] 2026-01-21 - Iteration 6: US-006 (Refactor ralph tasks to use skill loading) completed

[Ralph Loop] 2026-01-21 09:15 UTC - Iteration 6: US-006 (Refactor ralph tasks to use skill loading) completed

---

## 2026-01-21 - US-007

**Story:** Refactor ralph once to use skill loading

### What was implemented
- Replaced `ITERATION_PROMPT` constant (200+ lines) with skill loading via `SkillLoader`
- Replaced `_build_iteration_prompt()` function with `_build_prompt_from_skill()`
- New function loads `ralph-iteration` skill content and appends story context section
- Added `SkillNotFoundError` handling to display clear error message if skill is missing
- Updated `loop.py` to use `_build_prompt_from_skill` from `once.py` (since it imports from once)
- Updated all test fixtures to include ralph-iteration skill directory

### Tests written
- Updated `TestBuildIterationPrompt` class to `TestBuildPromptFromSkill` with skill-based tests:
  - `test_prompt_includes_story_details` - Verifies story ID, title, description are in prompt
  - `test_prompt_includes_acceptance_criteria` - Verifies acceptance criteria are in prompt
  - `test_prompt_includes_max_fix_attempts` - Verifies max fix attempts value is in prompt
  - `test_prompt_loads_skill_content` - Verifies skill content is loaded
  - `test_prompt_includes_context_section` - Verifies context section is added
  - `test_raises_when_skill_not_found` - Verifies SkillNotFoundError raised
- Added `test_once_handles_skill_not_found` to TestOnceCommand
- Added `test_loop_handles_skill_not_found` to TestLoopCommand
- Created `initialized_project_with_skill` fixture for tests that invoke once/loop commands
- Updated integration test fixtures in `test_autonomous_iteration.py` and `test_command_integration.py`

### Files changed
- `src/ralph/commands/once.py` (refactored to use SkillLoader)
- `src/ralph/commands/loop.py` (updated imports and function call)
- `tests/test_commands/test_once.py` (updated test classes and fixtures)
- `tests/test_commands/test_loop.py` (removed TestBuildIterationPrompt, updated fixtures)
- `tests/test_integration/test_autonomous_iteration.py` (added skill to project fixture)
- `tests/test_integration/test_command_integration.py` (added skill to project fixture)

### Learnings for future iterations
- When a function is imported from another module (like once.py exports functions used by loop.py), the refactor must update both files
- Integration tests with their own fixtures need the skill directory added to those fixtures
- The skill loading pattern is consistent: load skill, build context section with parameters, concatenate and return

---

[Ralph Loop] 2026-01-21 09:24 UTC - Iteration 7: US-007 (Refactor ralph once to use skill loading) completed

---

## 2026-01-21 - US-008

**Story:** Refactor ralph loop to use skill loading

### What was implemented
- Verified that loop.py already uses skill loading via `_build_prompt_from_skill` imported from once.py
- Confirmed no embedded prompt constants exist in loop.py
- All quality checks pass (typecheck, lint, format, tests)

### Tests written
- No new tests needed - existing tests already cover skill loading:
  - `test_loop_handles_skill_not_found` verifies error handling when skill is missing
  - Integration tests use `initialized_project_with_skill` fixture

### Files changed
- `plans/TASKS.json` (marked US-008 as passes: true)
- `plans/PROGRESS.txt` (this entry)

### Learnings for future iterations
- Some stories may already be complete due to work done in previous stories
- When once.py and loop.py share functionality, refactoring once.py automatically updates loop.py
- Always verify acceptance criteria are met even if no code changes are needed

---

[Ralph Loop] 2026-01-21 09:30 UTC - Iteration 8: US-008 (Refactor ralph loop to use skill loading) completed