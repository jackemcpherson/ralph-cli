# Ralph Progress Log

## Codebase Patterns

- Use Pydantic `alias` with `populate_by_name=True` when JSON uses camelCase but Python should use snake_case
- Use `by_alias=True` in `model_dump_json()` to serialize back to the original JSON format
- Import `Iterator`, `Sequence`, etc. from `collections.abc` instead of `typing` (ruff UP035)
- Use Pydantic `BaseModel` for all classes, NOT stdlib `@dataclass` - this is a Pydantic project
- Use `ConfigDict(arbitrary_types_allowed=True)` when fields use types like `Path` or `TextIO`

---

## Log

(Iteration entries will be appended below)

---

## 2026-01-17 - US-007

**Story:** Create Claude Code CLI wrapper service

### What was implemented
- Created `src/ralph/services/claude.py` with ClaudeService dataclass
- `run_interactive(prompt)` - Launches Claude Code interactively with optional initial prompt
- `run_print_mode(prompt)` - Executes with -p flag, supports streaming output to terminal
- `run_with_output_format(prompt, format)` - Runs with specific output format (text/json/stream-json)
- All methods support: --verbose flag, model selection, max_turns, system_prompt, allowed_tools
- `_stream_output()` helper streams stdout line-by-line to terminal in real-time
- `_build_base_args()` constructs base CLI arguments
- Created `ClaudeError` exception class for operation failures
- Updated `services/__init__.py` to export ClaudeService and ClaudeError

### Files changed
- src/ralph/services/claude.py (new)
- src/ralph/services/__init__.py (modified)

### Learnings for future iterations
- Use `subprocess.Popen` with `stdout=PIPE` for streaming line-by-line output
- Use configurable `stdout`/`stderr` TextIO fields for testability (can inject StringIO in tests)
- Break long error messages across multiple lines to satisfy ruff E501 (max 100 chars)

---

## 2026-01-17 - US-006

**Story:** Create Git service for branch management

### What was implemented
- Created `src/ralph/services/git.py` with GitService dataclass
- `get_current_branch()` - Returns current branch name using `git branch --show-current`
- `get_default_branch()` - Detects main/master by checking local branches and remote HEAD
- `branch_exists(name)` - Checks if a branch exists locally
- `checkout_or_create_branch(name, base)` - Switches to branch, creates from base if needed
- `commit(message, add_all)` - Creates commit, optionally staging all changes first
- `has_changes()` - Checks for uncommitted changes via `git status --porcelain`
- `stage_files(files)` - Stages specific files for commit
- Created `GitError` exception class for operation failures
- Updated `services/__init__.py` to export GitService and GitError

### Files changed
- src/ralph/services/git.py (new)
- src/ralph/services/__init__.py (modified)

### Learnings for future iterations
- Use `@dataclass` for service classes that need configuration (like working_dir)
- `subprocess.run()` with `text=True` returns string output instead of bytes
- Check both local branches and remote HEAD when detecting default branch

---

## 2026-01-17 - US-005

**Story:** Create file operation utilities

### What was implemented
- Created `src/ralph/utils/files.py` with file operation utilities
- `ensure_dir(path)` - Creates directory and parents if they don't exist
- `read_file(path, encoding)` - Reads file contents with configurable encoding
- `write_file(path, content, encoding)` - Writes content to file, creates parent dirs
- `append_file(path, content, encoding)` - Appends content, creates file if needed
- `file_exists(path)` - Checks if path exists and is a file
- `get_project_root()` - Walks up directory tree looking for project markers (pyproject.toml, package.json, go.mod, Cargo.toml, CLAUDE.md, .git)
- Updated `utils/__init__.py` to export all new functions

### Files changed
- src/ralph/utils/files.py (new)
- src/ralph/utils/__init__.py (modified)

### Learnings for future iterations
- Using `pathlib.Path` provides clean, cross-platform file operations
- `Path.mkdir(parents=True, exist_ok=True)` is equivalent to `mkdir -p`
- Always create parent directories when writing files to prevent errors

---

## 2026-01-17 - US-004

**Story:** Create Rich console utilities

### What was implemented
- Created `src/ralph/utils/console.py` with Rich-based console helpers
- Added shared `Console` instance for consistent output across the application
- Implemented `print_success()` with green checkmark for success messages
- Implemented `print_error()` with red X for error messages
- Implemented `print_warning()` with yellow warning sign for warning messages
- Implemented `print_step()` for iteration progress display (e.g., `[1/5] Processing...`)
- Implemented `create_spinner()` context manager using Rich's status spinner
- Updated `utils/__init__.py` to export all public symbols

### Files changed
- src/ralph/utils/console.py (new)
- src/ralph/utils/__init__.py (modified)

### Learnings for future iterations
- Import `Iterator` from `collections.abc` instead of `typing` to satisfy ruff UP035 rule
- Rich's `console.status()` provides an easy way to create spinners with context manager syntax

---

## 2026-01-17 - US-003

**Story:** Create configuration models and quality check parser

### What was implemented
- Created `src/ralph/models/config.py` with QualityCheck and QualityChecks Pydantic models
- QualityCheck model includes: name, command, required (with default=True)
- QualityChecks model contains a list of QualityCheck items
- Implemented `parse_quality_checks()` to extract YAML between RALPH:CHECKS:START and RALPH:CHECKS:END markers using regex
- Implemented `load_quality_checks()` helper to load directly from a file path
- Parser returns empty QualityChecks on missing markers or malformed YAML (graceful degradation)
- Added pyyaml>=6.0.0 dependency to pyproject.toml
- Updated `models/__init__.py` to export all new public symbols

### Files changed
- src/ralph/models/config.py (new)
- src/ralph/models/__init__.py (modified)
- pyproject.toml (modified)
- uv.lock (modified)

### Learnings for future iterations
- Use `yaml.safe_load()` for security when parsing untrusted YAML content
- Regex with `re.DOTALL` flag is useful for matching across multiple lines
- Return empty container models instead of None for graceful handling of missing/malformed data

---

## 2026-01-17 - US-002

**Story:** Create Pydantic models for TASKS.json

### What was implemented
- Created `src/ralph/models/tasks.py` with UserStory and TasksFile Pydantic models
- UserStory model includes: id, title, description, acceptance_criteria, priority, passes, notes
- TasksFile model includes: project, branch_name, description, user_stories
- Used Pydantic aliases to maintain camelCase JSON compatibility (e.g., `acceptanceCriteria` in JSON maps to `acceptance_criteria` in Python)
- Implemented `load_tasks()` function to read and validate TASKS.json files
- Implemented `save_tasks()` function to serialize models back to JSON with proper camelCase
- Updated `models/__init__.py` to export all public symbols

### Files changed
- src/ralph/models/tasks.py (new)
- src/ralph/models/__init__.py (modified)

### Learnings for future iterations
- Ruff lint rule N815 flags mixedCase variables; use Pydantic aliases to satisfy both Python conventions and external JSON schemas
- `ConfigDict(populate_by_name=True)` allows models to accept both alias (camelCase) and field name (snake_case)
- Remember to use `by_alias=True` when serializing to preserve original JSON format

---

## 2026-01-17 - US-001

**Story:** Initialize project structure with pyproject.toml

### What was implemented
- Created pyproject.toml with all required dependencies (typer, rich, pydantic, ruff, pytest, pytest-cov, pyright)
- Configured hatchling build backend with src layout
- Set up Python 3.11+ requirement
- Created src/ralph/ directory structure with __init__.py files
- Created empty module directories: commands/, models/, services/, utils/
- Created basic cli.py with Typer app entry point
- Added README.md with basic documentation
- Added .gitignore for Python projects
- Added initial test for version verification
- Verified package installs successfully with `uv pip install -e ".[dev]"`

### Files changed
- pyproject.toml (new)
- README.md (new)
- .gitignore (new)
- src/ralph/__init__.py (new)
- src/ralph/cli.py (new)
- src/ralph/commands/__init__.py (new)
- src/ralph/models/__init__.py (new)
- src/ralph/services/__init__.py (new)
- src/ralph/utils/__init__.py (new)
- tests/__init__.py (new)
- tests/test_init.py (new)

### Learnings for future iterations
- pytest returns exit code 5 when no tests are collected, so at least one test file is needed
- hatchling requires README.md to exist if referenced in pyproject.toml
- uv requires a virtual environment to be created first with `uv venv`

---
