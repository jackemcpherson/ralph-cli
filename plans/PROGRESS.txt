# Ralph Progress Log

## Codebase Patterns

- Use `create_console()` from `ralph.utils.console` for consistent Windows encoding handling
- When mocking `sys.platform` for Windows tests, use `"win32"` (not `"windows"`)
- Normalize encoding strings by lowercasing and removing hyphens for comparison (e.g., `"UTF-8"` -> `"utf8"`)

---

## Log

(Iteration entries will be appended below)

---

## 2026-01-20 - US-001

**Story:** Windows encoding detection for Rich console

### What was implemented
- Created `create_console()` function in `src/ralph/utils/console.py` that detects Windows legacy encodings
- Added `LEGACY_WINDOWS_ENCODINGS` constant containing `cp1252`, `cp437`, and `ascii`
- Console now uses `legacy_windows=True` for legacy encodings on Windows platform
- Console uses default settings for UTF-8 terminals and non-Windows platforms
- Encoding detection handles edge cases: missing encoding attribute, None encoding, various UTF-8 case variations

### Tests written
- `TestCreateConsole` class with 10 test cases:
  - `test_returns_console_instance` - Verifies function returns Console
  - `test_legacy_encodings_constant` - Verifies constant contains expected encodings
  - `test_windows_legacy_encoding_enables_legacy_mode` - Parametrized test for cp1252, cp437, ascii
  - `test_windows_utf8_encoding_uses_default` - Parametrized test for utf-8 variations
  - `test_non_windows_platform_uses_default` - Verifies macOS uses default
  - `test_linux_platform_uses_default` - Verifies Linux uses default
  - `test_missing_encoding_attribute_defaults_to_utf8` - Edge case handling
  - `test_none_encoding_defaults_to_utf8` - Edge case handling
  - `test_encoding_normalization_removes_hyphen` - Verifies UTF-8 normalization

### Files changed
- `src/ralph/utils/console.py` - Added `create_console()` function and `LEGACY_WINDOWS_ENCODINGS` constant
- `tests/test_utils/test_console.py` - Added `TestCreateConsole` test class with encoding scenarios

### Learnings for future iterations
- Rich Console's `legacy_windows` parameter disables Unicode characters that may fail on legacy Windows terminals
- Python's `sys.stdout.encoding` may be None in some environments, so always provide a fallback
- Use `MagicMock(spec=[])` to create a mock without an `encoding` attribute for testing edge cases

---
